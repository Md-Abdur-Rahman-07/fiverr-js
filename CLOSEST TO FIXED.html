<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Production Off Sheet Manager</title>
  <style>
    /* Base Styles */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #333; line-height: 1.6; }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #f0f9ff; }
    .app-container { background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow: hidden; }
    .header { background-color: #2563eb; color: white; padding: 20px; }
    .logo-container { text-align: center; margin-bottom: 15px; }
    .app-logo { 
      display: inline-block;
      width: 80px;
      height: 80px;
      background-color: white;
      border-radius: 50%;
      position: relative;
      border: 3px solid black;
    }
    .app-logo::before {
      content: "DC";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 40px;
      font-weight: bold;
      color: black;
    }
    .header-content { text-align: center; }
    .header h1 { margin: 0; font-size: 24px; }
    .header p { margin: 5px 0 0; opacity: 0.8; }
    .header p { margin: 5px 0 0; opacity: 0.8; }
    .content { padding: 20px; }
    .field { margin-bottom: 15px; }
    .field label { display: block; font-size: 14px; font-weight: 500; color: #4b5563; margin-bottom: 5px; }
    input[type="text"], input[type="date"], input[type="time"], select, textarea { 
      padding: 8px; 
      border: 1px solid #d1d5db; 
      border-radius: 4px; 
      width: 100%;
      box-sizing: border-box;
    }
    .button { 
      background-color: #2563eb; 
      color: white; 
      border: none; 
      padding: 8px 15px; 
      border-radius: 4px; 
      cursor: pointer; 
      display: inline-flex; 
      align-items: center; 
      gap: 5px; 
      font-size: 14px; 
    }
    .button.green { background-color: #059669; }
    .button.purple { background-color: #7c3aed; }
    .button.red { background-color: #dc2626; }
    .button.orange { background-color: #ea580c; }
    .button.gray { background-color: #6b7280; }
    .button:hover { opacity: 0.9; }
    .button:disabled { opacity: 0.5; cursor: not-allowed; }
    .tab-container { display: flex; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
    .tab { 
      padding: 10px 20px; 
      cursor: pointer; 
      background-color: #f9fafb; 
      border: 1px solid #e5e7eb; 
      border-bottom: none;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
      margin-right: 5px;
      font-weight: 500;
    }
    .tab.active { 
      background-color: white; 
      border-bottom: 1px solid white; 
      margin-bottom: -1px;
      color: #2563eb;
      font-weight: bold;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .sections { display: flex; flex-wrap: wrap; gap: 20px; }
    .section { flex: 1; min-width: 300px; }
    .section-title { 
      font-size: 18px; 
      font-weight: bold; 
      margin-bottom: 15px; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
    }
    .card { 
      background-color: #f0f9ff; 
      border-radius: 6px; 
      padding: 15px; 
      margin-bottom: 20px; 
    }
    .card-title {
      font-size: 16px; 
      color: #1e40af; 
      margin-top: 0; 
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card h3 { font-size: 16px; color: #1e40af; margin-top: 0; margin-bottom: 10px; }
    .cast-item { display: flex; align-items: center; margin-bottom: 8px; }
    .cast-item input[type="checkbox"] { margin-right: 8px; width: 16px; height: 16px; }
    .cast-item label { user-select: none; }
    .cast-name { font-weight: 500; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e5e7eb; }
    th { font-weight: 600; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; }
    .status-original { background-color: #d1fae5; color: #065f46; }
    .status-off { background-color: #fef3c7; color: #92400e; }
    .status-cascade { background-color: #dbeafe; color: #1e40af; }
    .row-off { background-color: #fffbeb; }
    .row-cascade { background-color: #f0f9ff; }
    .uncovered { color: #dc2626; font-weight: bold; }
    .yellow-card { 
      background-color: #fffbeb; 
      border: 1px solid #fcd34d; 
      border-radius: 6px; 
      padding: 15px; 
      margin-top: 20px; 
    }
    .yellow-card p.title { font-weight: bold; margin-top: 0; margin-bottom: 10px; }
    .yellow-card ul { margin: 0; padding-left: 20px; }
    .yellow-card li { margin-bottom: 5px; }
    .print-area { display: none; }
    .mb-3 { margin-bottom: 15px; }
    .mt-3 { margin-top: 15px; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 8px; }
    .gap-4 { gap: 16px; }
    .w-full { width: 100%; }
    .grid { display: grid; }
    .grid-cols-1 { grid-template-columns: 1fr; }
    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
    .col-span-2 { grid-column: span 2; }
    .border { border: 1px solid #e5e7eb; }
    .rounded { border-radius: 4px; }
    .p-2 { padding: 8px; }
    .p-4 { padding: 16px; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-4 { margin-bottom: 16px; }
    .bg-gray-50 { background-color: #f9fafb; }
    .text-sm { font-size: 14px; }
    .font-medium { font-weight: 500; }
    .text-gray-500 { color: #6b7280; }
    .text-red-500 { color: #ef4444; }
    .hidden { display: none; }
    .file-input { display: none; }
    
    /* Special Scene Card */
    .special-scene-card { 
      background-color: #f0fff4; 
      border: 2px solid #10b981;
      border-radius: 6px; 
      padding: 15px; 
      margin-bottom: 20px; 
    }
    .special-scene-card h3 { 
      color: #047857; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .special-scene-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      color: #047857;
    }
    .special-scene-subtitle {
      font-style: italic;
      margin-bottom: 15px;
      font-size: 14px;
      color: #065f46;
    }
    
    /* Modal Styles */
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background-color: rgba(0,0,0,0.7); 
      z-index: 1000; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      display: none; 
    }
    .modal-content { 
      background-color: white; 
      border-radius: 8px; 
      max-width: 95%; 
      max-height: 95%; 
      overflow: auto; 
      padding: 20px; 
      position: relative; 
      box-shadow: 0 0 20px rgba(0,0,0,0.3); 
    }
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px; 
      padding-bottom: 10px; 
      border-bottom: 1px solid #e5e7eb; 
    }
    .modal-title { font-size: 20px; font-weight: bold; margin: 0; }
    .close-button { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
    .modal-footer { 
      display: flex; 
      justify-content: flex-end; 
      margin-top: 15px; 
      padding-top: 10px; 
      border-top: 1px solid #e5e7eb; 
      gap: 10px;
    }
    
    /* PDF Specific Styles */
    .pdf-container { max-width: 210mm; margin: 0 auto; font-family: Arial, sans-serif; }
    .pdf-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .pdf-logo-container { text-align: center; margin-bottom: 10px; }
    .pdf-logo {
      display: inline-block;
      width: 60px;
      height: 60px;
      background-color: white;
      border-radius: 50%;
      position: relative;
      border: 3px solid black;
      margin: 0 auto;
    }
    .pdf-logo::before {
      content: "DC";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 30px;
      font-weight: bold;
      color: black;
    }
    .pdf-title { font-size: 18px; font-weight: bold; margin: 0 0 5px 0; }
    .pdf-subtitle { font-size: 14px; margin: 0; }
    .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 6px; font-size: 11px; vertical-align: top; }
    .pdf-table th { background-color: #e6f3ff; text-align: center; font-weight: bold; }
    .pdf-table tr.section-header td { background-color: #e6f3ff; font-weight: bold; text-align: center; }
    .pdf-table td strong { display: block; margin-bottom: 4px; font-size: 12px; color: #1e40af; }
    .pdf-table td.no-costume { background-color: #fff9e6; }
    .costume-info { font-style: italic; color: #333; }
    .pdf-notes { padding: 10px; border: 1px solid #000; margin-bottom: 15px; font-size: 12px; }
    .pdf-notes h3 { margin-top: 0; margin-bottom: 8px; font-size: 14px; }
    .pdf-notes ul { margin-top: 5px; margin-bottom: 5px; padding-left: 20px; }
    .pdf-notes li { margin-bottom: 3px; }
    .pdf-warning { background-color: #fff9e6; padding: 10px; border: 1px solid #ffc107; border-left: 4px solid #ffc107; margin-top: 10px; }
    
    /* Drag and Drop Styles */
    .draggable {
      cursor: move;
      border: 1px solid #e5e7eb;
      background-color: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
    .draggable.dragging {
      opacity: 0.5;
      background-color: #f3f4f6;
    }
    .drop-container {
      min-height: 40px;
      border: 1px dashed #d1d5db;
      background-color: #f9fafb;
      padding: 10px;
      border-radius: 4px;
    }
    .drop-container.drag-over {
      background-color: #e0f2fe;
      border-color: #3b82f6;
    }
    
    /* List Styles */
    .list-item {
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item-content {
      flex: 1;
    }
    .list-item-actions {
      display: flex;
      gap: 4px;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #10b981;
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      transform: translateY(50px);
      transition: opacity 0.3s, transform 0.3s;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.error {
      background-color: #ef4444;
    }
    
    /* Custom Select & Multi-Select Styles */
    .custom-select-container {
      position: relative;
      width: 100%;
    }
    .custom-select-selected {
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .custom-select-selected .arrow {
      border: solid #6b7280;
      border-width: 0 2px 2px 0;
      display: inline-block;
      padding: 3px;
      transform: rotate(45deg);
      transition: transform 0.3s;
    }
    .custom-select-selected.active .arrow {
      transform: rotate(-135deg);
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 4px 4px;
      background-color: white;
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .custom-select-dropdown.show {
      display: block;
    }
    .custom-select-option {
      padding: 8px;
      cursor: pointer;
    }
    .custom-select-option:hover {
      background-color: #f3f4f6;
    }
    .custom-select-option.selected {
      background-color: #e0f2fe;
    }
    .custom-select-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 5px 0;
    }
    .custom-select-tag {
      background-color: #e0f2fe;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .custom-select-tag-remove {
      cursor: pointer;
      font-weight: bold;
    }
    
    /* Print styles */
    @media print {
      body { background-color: white; padding: 0; }
      .container, .app-container, .header, .content, .modal-overlay { display: none; }
      #pdf-view { display: block; }
      .pdf-container { max-width: 100%; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .grid-cols-2, .grid-cols-3, .grid-cols-4 {
        grid-template-columns: 1fr;
      }
      .col-span-2 {
        grid-column: span 1;
      }
      .sections {
        flex-direction: column;
      }
    }
  </style>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="app-container">
      <div class="header">
        <div class="logo-container">
          <div class="app-logo"></div>
        </div>
        <div class="header-content">
          <h1 id="production-header-title">Production Off Sheet Manager</h1>
          <p id="production-header-subtitle">Create and manage understudy and swing assignments</p>
        </div>
      </div>
      
      <div class="content">
        <!-- Tabs Navigation -->
                  <div class="tab-container">
          <div class="tab active" data-tab="daily-operations">Daily Operations</div>
          <div class="tab" data-tab="production-setup">Production Setup</div>
          <div class="tab" data-tab="cast-management">Cast Management</div>
          <div class="tab" data-tab="scene-management">Scene Management</div>
          <div class="tab" data-tab="props-tracking">Props & Costumes</div>
          <div class="tab" data-tab="special-tracks">Special Tracks</div>
          <div class="tab" data-tab="performance-history">Performance History</div>
          <div class="tab" data-tab="settings">Settings</div>
        </div>
        
        <!-- Daily Operations Tab -->
        <div id="daily-operations" class="tab-content active">
          <div class="controls">
            <div class="grid grid-cols-4 gap-4">
              <div class="field">
                <label for="show-date">Show Date</label>
                <input type="date" id="show-date" value="">
              </div>
              
              <div class="field">
                <label for="performance-time">Performance Time</label>
                <input type="time" id="performance-time" value="19:30">
              </div>
              
              <div class="field">
                <label for="venue">Venue</label>
                <input type="text" id="venue" placeholder="Enter venue name">
              </div>
              
              <div class="field" style="display: flex; align-items: flex-end;">
                <div class="flex gap-2">
                  <button id="save-btn" class="button green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Save
                  </button>
                  
                  <label for="load-file" class="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    Load
                    <input type="file" id="load-file" class="file-input" accept=".json">
                  </label>
                  
                  <button id="print-btn" class="button purple">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    Print
                  </button>
                  
                  <button id="generate-pdf-btn" class="button red">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Generate PDF
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="sections">
            <div class="section">
              <div class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="17" y1="8" x2="23" y2="14"></line><line x1="23" y1="8" x2="17" y2="14"></line></svg>
                Select Who's Off Today
              </div>
              
              <div class="card">
                <h3>Main Cast</h3>
                <div id="main-cast-list">
                  <!-- Main cast checkboxes will be inserted here by JavaScript -->
                  <div class="cast-item">
                    <p class="text-gray-500 text-sm">No cast members configured. Go to Cast Management to add performers.</p>
                  </div>
                </div>
              </div>
              
              <div class="card">
                <h3>Swings</h3>
                <div id="swings-list">
                  <!-- Swings checkboxes will be inserted here by JavaScript -->
                  <div class="cast-item">
                    <p class="text-gray-500 text-sm">No swings configured. Go to Cast Management to add swings.</p>
                  </div>
                </div>
              </div>
              
              <!-- Container for Special Track Assignments -->
              <div id="special-tracks-container">
                <!-- Special tracks will be inserted here by JavaScript -->
              </div>
              
              <div class="card">
                <h3>Performance Notes</h3>
                <textarea id="performance-notes" placeholder="Add any additional notes about today's performance..."></textarea>
              </div>
            </div>
            
            <div class="section">
              <div class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><polyline points="16 11 18 13 22 9"></polyline></svg>
                Today's Cast
              </div>
              
              <div class="card">
                <table id="daily-cast-table">
                  <thead>
                    <tr>
                      <th>Role</th>
                      <th>Performing Today</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Daily cast entries will be inserted here by JavaScript -->
                    <tr>
                      <td colspan="3" class="text-center text-gray-500 text-sm">No cast members configured</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="card">
                <h3>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                  Coverage Details
                </h3>
                <div id="off-summary" style="white-space: pre-line;">
                  <!-- Off summary text will be inserted here by JavaScript -->
                </div>
              </div>
              
              <div id="production-rules-container" class="yellow-card">
                <p class="title">Production Rules:</p>
                <div id="production-rules-content">
                  <!-- Production rules will be inserted here by JavaScript -->
                  <p class="text-gray-500 text-sm">No rules configured. Go to Settings to add production rules.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Production Setup Tab -->
        <div id="production-setup" class="tab-content">
          <div class="section-title mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            Production Information
          </div>
          
          <div class="card">
            <div class="grid grid-cols-2 gap-4">
              <div class="field">
                <label for="production-name">Production Name</label>
                <input type="text" id="production-name" placeholder="e.g. Hamilton, The Phantom of the Opera" value="">
              </div>
              
              <div class="field">
                <label for="production-subtitle">Production Subtitle</label>
                <input type="text" id="production-subtitle" placeholder="e.g. UK Tour 2023-24, West End Production" value="">
              </div>
              
              <div class="field">
                <label for="default-venue">Default Venue</label>
                <input type="text" id="default-venue" placeholder="e.g. Apollo Theatre, London" value="">
              </div>
              
              <div class="field">
                <label for="default-time">Default Performance Time</label>
                <input type="time" id="default-time" value="19:30">
              </div>
            </div>
            
            <div class="field mt-4">
              <label for="production-description">Production Description</label>
              <textarea id="production-description" rows="3" placeholder="Brief description of the production"></textarea>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button id="save-production-info" class="button green">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Save Information
              </button>
            </div>
          </div>
          
          <div class="section-title mb-4 mt-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            Production Configuration
          </div>
          
          <div class="card">
            <div class="field">
              <label for="export-production">Export Configuration</label>
              <p class="text-sm text-gray-500 mb-2">Export the entire production setup to share with others or backup.</p>
              <button id="export-production-btn" class="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Export Production Configuration
              </button>
            </div>
            
            <div class="field mt-4">
              <label for="import-production">Import Configuration</label>
              <p class="text-sm text-gray-500 mb-2">Import a complete production configuration. This will overwrite current settings.</p>
              <div class="flex items-center gap-2">
                <label for="import-production-file" class="button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                  Select Production File
                  <input type="file" id="import-production-file" class="file-input" accept=".json">
                </label>
              </div>
            </div>
            
            <div class="field mt-4">
              <label for="reset-production">Reset Configuration</label>
              <p class="text-sm text-gray-500 mb-2">Reset the entire production configuration. This cannot be undone.</p>
              <button id="reset-production-btn" class="button red">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                Reset All Production Data
              </button>
            </div>
          </div>
        </div>
        
        <!-- Cast Management Tab -->
        <div id="cast-management" class="tab-content">
          <div class="sections">
            <div class="section">
              <div class="section-title mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Roles & Cast Members
              </div>
              
              <div class="card">
                <div class="card-title">
                  <h3>Add New Role</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div class="field">
                    <label for="new-role-name">Role Name</label>
                    <input type="text" id="new-role-name" placeholder="e.g. Hamlet, Elphaba, Jean Valjean">
                  </div>
                  
                  <div class="field">
                    <label for="new-role-type">Role Type</label>
                    <select id="new-role-type">
                      <option value="lead">Lead</option>
                      <option value="supporting">Supporting</option>
                      <option value="ensemble">Ensemble</option>
                      <option value="featured">Featured Ensemble</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
                
                <div class="field mt-2">
                  <label for="new-role-actor">Default Performer</label>
                  <input type="text" id="new-role-actor" placeholder="Name of the principal performer for this role">
                </div>
                
                <div class="grid grid-cols-3 gap-4 mt-2">
                  <div class="field">
                    <label for="new-role-understudy1">1st Understudy</label>
                    <input type="text" id="new-role-understudy1" placeholder="1st choice cover">
                  </div>
                  
                  <div class="field">
                    <label for="new-role-understudy2">2nd Understudy</label>
                    <input type="text" id="new-role-understudy2" placeholder="2nd choice cover">
                  </div>
                  
                  <div class="field">
                    <label for="new-role-understudy3">3rd Understudy</label>
                    <input type="text" id="new-role-understudy3" placeholder="3rd choice cover">
                  </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                  <button id="add-role-btn" class="button green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Role
                  </button>
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-title">
                  <h3>Roles & Cast List</h3>
                  <div class="flex gap-2">
                    <button id="save-cast-list-btn" class="button green" title="Save cast list">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    </button>
                  </div>
                </div>
                
                <div id="cast-list-container">
                  <!-- Cast list will be inserted here by JavaScript -->
                  <p class="text-gray-500 text-sm">No roles defined yet. Add roles using the form above.</p>
                </div>
              </div>
            </div>
            
            <div class="section">
              <div class="section-title mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                Swings & Offstage Covers
              </div>
              
              <div class="card">
                <div class="card-title">
                  <h3>Add New Swing/Cover</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div class="field">
                    <label for="new-swing-role">Swing Role/Track</label>
                    <input type="text" id="new-swing-role" placeholder="e.g. Male Swing 1, Dance Captain">
                  </div>
                  
                  <div class="field">
                    <label for="new-swing-actor">Performer Name</label>
                    <input type="text" id="new-swing-actor" placeholder="Name of the swing performer">
                  </div>
                </div>
                
                <div class="field mt-2">
                  <label for="new-swing-notes">Cover Notes</label>
                  <textarea id="new-swing-notes" rows="2" placeholder="Any notes about this swing's coverage or responsibilities"></textarea>
                </div>
                
                <div class="field mt-2">
                  <label for="new-swing-roles">Covers Roles (Comma separated)</label>
                  <input type="text" id="new-swing-roles" placeholder="Role 1, Role 2, Role 3">
                </div>
                
                <div class="flex gap-2 mt-4">
                  <button id="add-swing-btn" class="button green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Swing
                  </button>
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-title">
                  <h3>Swings & Covers List</h3>
                  <div class="flex gap-2">
                    <button id="save-swings-list-btn" class="button green" title="Save swings list">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    </button>
                  </div>
                </div>
                
                <div id="swings-list-container">
                  <!-- Swings list will be inserted here by JavaScript -->
                  <p class="text-gray-500 text-sm">No swings defined yet. Add swings using the form above.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scene Management Tab -->
        <div id="scene-management" class="tab-content">
          <div class="sections">
            <div class="section">
              <div class="section-title mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
                Show Structure & Scenes
              </div>
              
              <div class="card">
                <div class="card-title">
                  <h3>Add New Act</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div class="field">
                    <label for="new-act-number">Act Number</label>
                    <input type="number" id="new-act-number" min="1" value="1">
                  </div>
                  
                  <div class="field">
                    <label for="new-act-name">Act Name (Optional)</label>
                    <input type="text" id="new-act-name" placeholder="e.g. Act One, Prelude, Finale">
                  </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                  <button id="add-act-btn" class="button green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Act
                  </button>
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-title">
                  <h3>Acts List</h3>
                  <div class="flex gap-2">
                    <button id="save-acts-btn" class="button green" title="Save acts list">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    </button>
                  </div>
                </div>
                
                <div id="acts-list-container">
                  <!-- Acts list will be inserted here by JavaScript -->
                  <p class="text-gray-500 text-sm">No acts defined yet. Add acts using the form above.</p>
                </div>
              </div>
            </div>
            
            <div class="section">
              <div class="section-title mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                Scenes & Costumes
              </div>
              
              <div class="card">
                <div class="card-title">
                  <h3>Add New Scene</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div class="field">
                    <label for="new-scene-act">Act</label>
                    <select id="new-scene-act">
                      <!-- Act options will be inserted here by JavaScript -->
                      <option value="">Select an Act</option>
                    </select>
                  </div>
                  
                  <div class="field">
                    <label for="new-scene-name">Scene Name</label>
                    <input type="text" id="new-scene-name" placeholder="e.g. Scene 1, Opening, Finale">
                  </div>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mt-2">
                  <div class="field">
                    <label for="new-scene-song">Song/Musical Number (Optional)</label>
                    <input type="text" id="new-scene-song" placeholder="e.g. Defying Gravity, One Day More">
                  </div>
                </div>
                
                <div class="field mt-2">
                  <label for="new-scene-costumes">Costume Requirements</label>
                  <div id="costume-assignments-container" class="border rounded p-4 bg-gray-50">
                    <div class="flex justify-between items-center mb-4">
                      <h4 class="m-0">Role Specific Costumes</h4>
                      <button id="add-costume-row-btn" class="button">+ Add Role</button>
                    </div>
                    
                    <div id="costume-rows">
                      <!-- Costume rows will be added here -->
                      <div class="costume-row grid grid-cols-2 gap-4 mb-2">
                        <div class="field">
                          <select class="costume-role">
                            <option value="">Select a Role</option>
                            <!-- Role options will be inserted here by JavaScript -->
                          </select>
                        </div>
                        <div class="field">
                          <input type="text" class="costume-description" placeholder="Costume description">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="field mt-4">
                  <label>
                    <input type="checkbox" id="new-scene-special">
                    This is a special scene with manual assignment
                  </label>
                  <p class="text-sm text-gray-500 mt-1">Special scenes allow manual assignment of performers regardless of the usual cover order.</p>
                </div>
                
                <div class="flex gap-2 mt-4">
                  <button id="add-scene-btn" class="button green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Scene
                  </button>
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-title">
                  <h3>Scenes List</h3>
                  <div class="flex gap-2">
                    <button id="save-scenes-btn" class="button green" title="Save scenes list">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    </button>
                  </div>
                </div>
                
                <div id="scenes-list-container">
                  <!-- Scenes list will be inserted here by JavaScript -->
                  <p class="text-gray-500 text-sm">No scenes defined yet. Add scenes using the form above.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Special Tracks Tab -->
        <div id="special-tracks" class="tab-content">
          <div class="section-title mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
            Special Track Assignments
          </div>
          
          <div class="card">
            <div class="card-title">
              <h3>Add New Special Track</h3>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">
              Special tracks are used for scenes or moments that don't follow the standard cover order and need
              manual assignment for each performance. For example, a special dance number, featured ensemble moment,
              or specialized roles like "Gay Boys" in Sister Act.
            </p>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="field">
                <label for="new-track-name">Track Name</label>
                <input type="text" id="new-track-name" placeholder="e.g. Gay Boys, Dance Feature, Specialty Number">
              </div>
              
              <div class="field">
                <label for="new-track-location">Scene Location</label>
                <select id="new-track-location">
                  <option value="">Select a Scene</option>
                  <!-- Scene options will be inserted here by JavaScript -->
                </select>
              </div>
            </div>
            
            <div class="field mt-2">
              <label for="new-track-description">Description</label>
              <textarea id="new-track-description" rows="2" placeholder="Description of this special track and its requirements"></textarea>
            </div>
            
            <div class="field mt-2">
              <label>Eligible Performers</label>
              <div id="eligible-performers-container" class="border rounded p-4 bg-gray-50">
                <p class="text-sm text-gray-500 mb-2">Select which cast members are eligible to perform this track:</p>
                <div id="eligible-performers-list" class="grid grid-cols-3 gap-2">
                  <!-- Eligible performers checkboxes will be inserted here by JavaScript -->
                  <p class="text-gray-500 text-sm">No cast members defined yet.</p>
                </div>
              </div>
            </div>
            
            <div class="field mt-2">
              <label for="new-track-count">Number of Performers Needed</label>
              <input type="number" id="new-track-count" min="1" value="1">
              <p class="text-sm text-gray-500 mt-1">How many performers are needed for this track per performance?</p>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button id="add-special-track-btn" class="button green">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Special Track
              </button>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-title">
              <h3>Special Tracks List</h3>
              <div class="flex gap-2">
                <button id="save-special-tracks-btn" class="button green" title="Save special tracks list">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                </button>
              </div>
            </div>
            
            <div id="special-tracks-list-container">
              <!-- Special tracks list will be inserted here by JavaScript -->
              <p class="text-gray-500 text-sm">No special tracks defined yet. Add special tracks using the form above.</p>
            </div>
          </div>
        </div>
        
        <!-- Props & Costumes Tab -->
        <div id="props-tracking" class="tab-content">
          <div class="section-title mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            Enhanced Costume & Prop Tracking
          </div>
          
          <div class="card">
            <div class="card-title">
              <h3>Add New Prop</h3>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="field">
                <label for="new-prop-name">Prop Name</label>
                <input type="text" id="new-prop-name" placeholder="e.g. Sword, Book, Phone">
              </div>
              
              <div class="field">
                <label for="new-prop-category">Category</label>
                <select id="new-prop-category">
                  <option value="hand-prop">Hand Prop</option>
                  <option value="set-prop">Set Prop</option>
                  <option value="personal">Personal Prop</option>
                  <option value="furniture">Furniture</option>
                  <option value="weapon">Weapon</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            
            <div class="field mt-2">
              <label for="new-prop-description">Description</label>
              <textarea id="new-prop-description" rows="2" placeholder="Details about the prop"></textarea>
            </div>
            
            <div class="field mt-2">
              <label for="new-prop-responsible">Responsible Department/Person</label>
              <input type="text" id="new-prop-responsible" placeholder="e.g. Props department, Actor name">
            </div>
            
            <div class="field mt-2">
              <label>Prop Appears In</label>
              <div id="prop-scenes-container" class="border rounded p-4 bg-gray-50">
                <p class="text-sm text-gray-500 mb-2">Select which scenes this prop appears in:</p>
                <div id="prop-scenes-list" class="grid grid-cols-2 gap-2">
                  <!-- Scene checkboxes will be inserted here by JavaScript -->
                </div>
              </div>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button id="add-prop-btn" class="button green">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Prop
              </button>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-title">
              <h3>Props List</h3>
              <div class="flex gap-2">
                <button id="save-props-btn" class="button green" title="Save props list">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                </button>
              </div>
            </div>
            
            <div id="props-list-container">
              <!-- Props list will be inserted here by JavaScript -->
              <p class="text-gray-500 text-sm">No props defined yet. Add props using the form above.</p>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-title">
              <h3>Track in Scene View</h3>
            </div>
            <div class="field">
              <label for="track-scene-select">Select Scene to View</label>
              <select id="track-scene-select">
                <option value="">Select a Scene</option>
                <!-- Scene options will be inserted here by JavaScript -->
              </select>
            </div>
            
            <div id="scene-tracking-container" class="mt-4">
              <!-- Scene tracking table will be inserted here by JavaScript -->
            </div>
          </div>
        </div>
        
        <!-- Performance History Tab -->
        <div id="performance-history" class="tab-content">
          <div class="section-title mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            Performance History & Statistics
          </div>
          
          <div class="card">
            <div class="card-title">
              <h3>Performance Calendar</h3>
            </div>
            
            <div class="field mb-4">
              <label for="performance-month">Select Month</label>
              <div class="flex gap-2">
                <input type="month" id="performance-month" class="flex-grow">
                <button id="view-calendar-btn" class="button">View</button>
              </div>
            </div>
            
            <div id="performance-calendar-container" class="border rounded p-4">
              <!-- Calendar view will be inserted here by JavaScript -->
              <p class="text-gray-500 text-sm">Select a month to view performances.</p>
            </div>
            
            <div class="mt-4">
              <button id="export-to-calendar-btn" class="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Export to Calendar (iCal)
              </button>
              
              <button id="export-google-calendar-btn" class="button ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Google Calendar
              </button>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-title">
              <h3>Saved Performances</h3>
            </div>
            
            <div class="field mb-4">
              <label for="performance-search">Search Performances</label>
              <input type="text" id="performance-search" placeholder="Search by date, venue, or cast member">
            </div>
            
            <div id="performances-list-container">
              <!-- Performances list will be inserted here by JavaScript -->
              <p class="text-gray-500 text-sm">No saved performances yet. Daily operations data will appear here when saved.</p>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-title">
              <h3>Performance Statistics</h3>
            </div>
            
            <div id="performance-stats-container" class="mt-4">
              <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="border rounded p-4 text-center">
                  <div class="text-2xl font-bold" id="stat-total-performances">0</div>
                  <div class="text-sm text-gray-500">Total Performances</div>
                </div>
                
                <div class="border rounded p-4 text-center">
                  <div class="text-2xl font-bold" id="stat-most-missed">-</div>
                  <div class="text-sm text-gray-500">Most Frequently Absent</div>
                </div>
                
                <div class="border rounded p-4 text-center">
                  <div class="text-2xl font-bold" id="stat-most-covered">-</div>
                  <div class="text-sm text-gray-500">Most Covered Role</div>
                </div>
              </div>
              
              <div id="stats-charts-container">
                <!-- Charts will be inserted here by JavaScript -->
                <p class="text-gray-500 text-sm">Performance data will appear here once you have saved performances.</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
          <div class="section-title mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            Production Rules & Settings
          </div>
          
          <div class="card">
            <div class="card-title">
              <h3>Production Rules</h3>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">
              Add production-specific rules that will be displayed in the Daily Operations tab.
              These can include special coverage instructions, track changes, or any other notes.
            </p>
            
            <div class="field">
              <label for="production-rules">Rules and Notes</label>
              <textarea id="production-rules" rows="10" placeholder="Enter production rules and notes..."></textarea>
              <p class="text-sm text-gray-500 mt-1">Use Markdown formatting if needed. This will be displayed in the Daily Operations tab.</p>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button id="save-rules-btn" class="button green">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Save Rules
              </button>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-title">
              <h3>Application Settings</h3>
            </div>
            
            <div class="field">
              <label for="auto-save">Auto-Save</label>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="auto-save" checked>
                <span>Automatically save changes when modifying cast, scenes, etc.</span>
              </div>
            </div>
            
            <div class="field mt-4">
              <label for="theme-selector">Application Theme</label>
              <select id="theme-selector">
                <option value="blue">Blue (Default)</option>
                <option value="green">Green</option>
                <option value="purple">Purple</option>
                <option value="red">Red</option>
                <option value="gray">Gray</option>
              </select>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button id="save-settings-btn" class="button green">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Save Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Printable area that will only be visible when printing -->
  <div id="print-area" class="print-area"></div>
  
  <!-- PDF Preview Modal -->
  <div id="pdf-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="pdf-modal-title" class="modal-title">
          <div class="modal-logo"></div>
          Production Off Sheet
        </h2>
        <button id="close-modal" class="close-button">&times;</button>
      </div>
      <div id="pdf-view"></div>
      <div class="modal-footer">
        <button id="download-pdf" class="button red">Download PDF</button>
        <button id="print-pdf" class="button purple">Print</button>
        <button id="email-pdf" class="button green">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
          Email
        </button>
        <button id="share-pdf" class="button blue">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
          Share
        </button>
      </div>
    </div>
  </div>
  
  <!-- Edit Modal -->
  <div id="edit-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 id="edit-modal-title" class="modal-title">
          <div class="modal-logo"></div>
          Edit Item
        </h2>
        <button id="close-edit-modal" class="close-button">&times;</button>
      </div>
      <div id="edit-modal-content"></div>
      <div class="modal-footer">
        <button id="cancel-edit" class="button gray">Cancel</button>
        <button id="save-edit" class="button green">Save Changes</button>
      </div>
    </div>
  </div>
  
  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 id="confirm-modal-title" class="modal-title">
          <div class="modal-logo"></div>
          Confirm Action
        </h2>
        <button id="close-confirm-modal" class="close-button">&times;</button>
      </div>
      <div id="confirm-modal-content" class="p-4">
        <p>Are you sure you want to proceed with this action?</p>
      </div>
      <div class="modal-footer">
        <button id="cancel-confirm" class="button gray">Cancel</button>
        <button id="confirm-action" class="button red">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <div id="toast-message">Operation successful</div>
  </div>
  
  <script>
    // Main application state
    const app = {
      production: {
        name: "",
        subtitle: "",
        defaultVenue: "",
        defaultTime: "19:30",
        description: ""
      },
      mainCast: [],
      swings: [],
      acts: [],
      scenes: [],
      specialTracks: [],
      props: [],
      performanceHistory: [],
      calendarIntegration: {
        enabled: false,
        calendarId: "",
        syncDirection: "export-only"
      },
      settings: {
        autoSave: true,
        theme: "blue",
        rules: "",
        emailSettings: {
          defaultRecipients: [],
          ccRecipients: [],
          emailTemplate: ""
        }
      },
      currentPerformance: {
        date: "",
        time: "19:30",
        venue: "",
        notes: "",
        offPerformers: [],
        specialAssignments: {},
        propAssignments: {}
      }
    };
    
    // Set today's date as default
    document.getElementById('show-date').value = new Date().toISOString().split('T')[0];
    app.currentPerformance.date = document.getElementById('show-date').value;
    
    // Variables to hold processed data
    let dailyCast = [];
    let offSummary = '';
    
    // DOM Elements
    const elements = {
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content'),
      dailyCastTable: document.getElementById('daily-cast-table').getElementsByTagName('tbody')[0],
      offSummary: document.getElementById('off-summary'),
      mainCastList: document.getElementById('main-cast-list'),
      swingsList: document.getElementById('swings-list'),
      specialTracksContainer: document.getElementById('special-tracks-container'),
      pdfModal: document.getElementById('pdf-modal'),
      pdfView: document.getElementById('pdf-view'),
      editModal: document.getElementById('edit-modal'),
      editModalContent: document.getElementById('edit-modal-content'),
      confirmModal: document.getElementById('confirm-modal'),
      confirmModalContent: document.getElementById('confirm-modal-content'),
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toast-message'),
      productionRulesContainer: document.getElementById('production-rules-container'),
      productionRulesContent: document.getElementById('production-rules-content')
    };
    
    // Tab Navigation
    elements.tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and tab contents
        elements.tabs.forEach(t => t.classList.remove('active'));
        elements.tabContents.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding tab content
        tab.classList.add('active');
        const tabContentId = tab.dataset.tab;
        document.getElementById(tabContentId).classList.add('active');
      });
    });
    
    // Load data from localStorage
    function loadFromLocalStorage() {
      try {
        const savedData = localStorage.getItem('productionOffSheetData');
        if (savedData) {
          const parsedData = JSON.parse(savedData);
          
          // Merge saved data with default structure
          app.production = { ...app.production, ...parsedData.production };
          app.mainCast = parsedData.mainCast || [];
          app.swings = parsedData.swings || [];
          app.acts = parsedData.acts || [];
          app.scenes = parsedData.scenes || [];
          app.specialTracks = parsedData.specialTracks || [];
          app.settings = { ...app.settings, ...parsedData.settings };
          app.currentPerformance = { ...app.currentPerformance, ...parsedData.currentPerformance };
          
          // Update UI with loaded data
          updateProductionInfo();
          updateCastList();
          updateSwingsList();
          updateActsList();
          updateScenesList();
          updateSpecialTracksList();
          updateSettingsUI();
          
          // Rebuild the daily operations UI
          buildMainCastList();
          buildSwingsList();
          buildSpecialTracksUI();
          processCastAssignments();
          
          showToast("Data loaded successfully!");
        }
      } catch (error) {
        console.error("Error loading data from localStorage:", error);
        showToast("Error loading data!", true);
      }
    }
    
    // Save data to localStorage
    function saveToLocalStorage() {
      try {
        localStorage.setItem('productionOffSheetData', JSON.stringify(app));
        return true;
      } catch (error) {
        console.error("Error saving data to localStorage:", error);
        showToast("Error saving data!", true);
        return false;
      }
    }
    
    // Update production information in the UI
    function updateProductionInfo() {
      // Update header
      document.getElementById('production-header-title').textContent = app.production.name || 'Production Off Sheet Manager';
      document.getElementById('production-header-subtitle').textContent = app.production.subtitle || 'Create and manage understudy and swing assignments';
      
      // Update form fields
      document.getElementById('production-name').value = app.production.name || '';
      document.getElementById('production-subtitle').value = app.production.subtitle || '';
      document.getElementById('default-venue').value = app.production.defaultVenue || '';
      document.getElementById('default-time').value = app.production.defaultTime || '19:30';
      document.getElementById('production-description').value = app.production.description || '';
      
      // Update venue in daily operations if not already set
      if (!document.getElementById('venue').value) {
        document.getElementById('venue').value = app.production.defaultVenue || '';
      }
      
      // Update PDF modal title
      document.getElementById('pdf-modal-title').textContent = `${app.production.name || 'Production'} Off Sheet`;
    }
    
    // Update cast list in the UI
    function updateCastList() {
      const castListContainer = document.getElementById('cast-list-container');
      
      if (app.mainCast.length === 0) {
        castListContainer.innerHTML = '<p class="text-gray-500 text-sm">No roles defined yet. Add roles using the form above.</p>';
        return;
      }
      
      let html = '';
      
      app.mainCast.forEach((castMember, index) => {
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="font-medium">${castMember.role}</div>
              <div class="text-sm">Performer: ${castMember.actor}</div>
              <div class="text-sm text-gray-500">
                Understudies: 
                ${castMember.understudy1 ? castMember.understudy1 : 'None'}
                ${castMember.understudy2 ? ', ' + castMember.understudy2 : ''}
                ${castMember.understudy3 ? ', ' + castMember.understudy3 : ''}
              </div>
            </div>
            <div class="list-item-actions">
              <button class="button" data-action="edit-cast" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </button>
              <button class="button red" data-action="delete-cast" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </div>
        `;
      });
      
      castListContainer.innerHTML = html;
      
      // Add event listeners to edit and delete buttons
      const editButtons = castListContainer.querySelectorAll('[data-action="edit-cast"]');
      const deleteButtons = castListContainer.querySelectorAll('[data-action="delete-cast"]');
      
      editButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          editCastMember(index);
        });
      });
      
      deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          confirmDeleteCastMember(index);
        });
      });
      
      // Update role selectors for costume assignments
      updateRoleSelectors();
    }
    
    // Update swings list in the UI
    function updateSwingsList() {
      const swingsListContainer = document.getElementById('swings-list-container');
      
      if (app.swings.length === 0) {
        swingsListContainer.innerHTML = '<p class="text-gray-500 text-sm">No swings defined yet. Add swings using the form above.</p>';
        return;
      }
      
      let html = '';
      
      app.swings.forEach((swing, index) => {
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="font-medium">${swing.role} - ${swing.actor}</div>
              ${swing.coversRoles ? `<div class="text-sm">Covers: ${swing.coversRoles}</div>` : ''}
              ${swing.notes ? `<div class="text-sm text-gray-500">${swing.notes}</div>` : ''}
            </div>
            <div class="list-item-actions">
              <button class="button" data-action="edit-swing" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </button>
              <button class="button red" data-action="delete-swing" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </div>
        `;
      });
      
      swingsListContainer.innerHTML = html;
      
      // Add event listeners to edit and delete buttons
      const editButtons = swingsListContainer.querySelectorAll('[data-action="edit-swing"]');
      const deleteButtons = swingsListContainer.querySelectorAll('[data-action="delete-swing"]');
      
      editButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          editSwing(index);
        });
      });
      
      deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          confirmDeleteSwing(index);
        });
      });
    }
    
    // Update acts list in the UI
    function updateActsList() {
      const actsListContainer = document.getElementById('acts-list-container');
      const newSceneActSelect = document.getElementById('new-scene-act');
      
      // Clear acts dropdown
      newSceneActSelect.innerHTML = '<option value="">Select an Act</option>';
      
      if (app.acts.length === 0) {
        actsListContainer.innerHTML = '<p class="text-gray-500 text-sm">No acts defined yet. Add acts using the form above.</p>';
        return;
      }
      
      let html = '';
      
      app.acts.forEach((act, index) => {
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="font-medium">Act ${act.number}${act.name ? ': ' + act.name : ''}</div>
            </div>
            <div class="list-item-actions">
              <button class="button" data-action="edit-act" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </button>
              <button class="button red" data-action="delete-act" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </div>
        `;
        
        // Add act to dropdown
        newSceneActSelect.innerHTML += `<option value="${act.number}">Act ${act.number}${act.name ? ': ' + act.name : ''}</option>`;
      });
      
      actsListContainer.innerHTML = html;
      
      // Add event listeners to edit and delete buttons
      const editButtons = actsListContainer.querySelectorAll('[data-action="edit-act"]');
      const deleteButtons = actsListContainer.querySelectorAll('[data-action="delete-act"]');
      
      editButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          editAct(index);
        });
      });
      
      deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          confirmDeleteAct(index);
        });
      });
    }
    
    // Update scenes list in the UI
    function updateScenesList() {
      const scenesListContainer = document.getElementById('scenes-list-container');
      const trackLocationSelect = document.getElementById('new-track-location');
      
      // Clear scenes dropdown for special tracks
      trackLocationSelect.innerHTML = '<option value="">Select a Scene</option>';
      
      if (app.scenes.length === 0) {
        scenesListContainer.innerHTML = '<p class="text-gray-500 text-sm">No scenes defined yet. Add scenes using the form above.</p>';
        return;
      }
      
      let html = '';
      
      app.scenes.forEach((scene, index) => {
        // Find the act name
        const act = app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' };
        
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="font-medium">Act ${act.number}${act.name ? ' (' + act.name + ')' : ''} - ${scene.name}</div>
              ${scene.song ? `<div class="text-sm">Song: ${scene.song}</div>` : ''}
              ${scene.isSpecial ? `<div class="text-sm text-green-600">Special Scene (Manual Assignment)</div>` : ''}
              <div class="text-sm">Costumes: ${Object.keys(scene.costumes || {}).length} roles</div>
            </div>
            <div class="list-item-actions">
              <button class="button" data-action="edit-scene" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </button>
              <button class="button red" data-action="delete-scene" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </div>
        `;
        
        // Add scene to dropdown
        trackLocationSelect.innerHTML += `<option value="${index}">Act ${act.number} - ${scene.name}${scene.song ? ' (' + scene.song + ')' : ''}</option>`;
      });
      
      scenesListContainer.innerHTML = html;
      
      // Add event listeners to edit and delete buttons
      const editButtons = scenesListContainer.querySelectorAll('[data-action="edit-scene"]');
      const deleteButtons = scenesListContainer.querySelectorAll('[data-action="delete-scene"]');
      
      editButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          editScene(index);
        });
      });
      
      deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          confirmDeleteScene(index);
        });
      });
    }
    
    // Update special tracks list in the UI
    function updateSpecialTracksList() {
      const specialTracksListContainer = document.getElementById('special-tracks-list-container');
      
      if (app.specialTracks.length === 0) {
        specialTracksListContainer.innerHTML = '<p class="text-gray-500 text-sm">No special tracks defined yet. Add special tracks using the form above.</p>';
        return;
      }
      
      let html = '';
      
      app.specialTracks.forEach((track, index) => {
        // Find the scene
        const sceneIndex = parseInt(track.sceneIndex);
        const scene = app.scenes[sceneIndex] || { name: 'Unknown Scene' };
        const act = scene.act ? app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' } : { number: '?', name: '' };
        
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="font-medium">${track.name}</div>
              <div class="text-sm">Location: Act ${act.number} - ${scene.name}</div>
              <div class="text-sm">Performers Needed: ${track.performerCount}</div>
              <div class="text-sm">Eligible Performers: ${track.eligiblePerformers ? track.eligiblePerformers.length : 0}</div>
              ${track.description ? `<div class="text-sm text-gray-500">${track.description}</div>` : ''}
            </div>
            <div class="list-item-actions">
              <button class="button" data-action="edit-track" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </button>
              <button class="button red" data-action="delete-track" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </div>
        `;
      });
      
      specialTracksListContainer.innerHTML = html;
      
      // Add event listeners to edit and delete buttons
      const editButtons = specialTracksListContainer.querySelectorAll('[data-action="edit-track"]');
      const deleteButtons = specialTracksListContainer.querySelectorAll('[data-action="delete-track"]');
      
      editButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          editSpecialTrack(index);
        });
      });
      
      deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          confirmDeleteSpecialTrack(index);
        });
      });
    }
    
    // Update settings UI
    function updateSettingsUI() {
      document.getElementById('auto-save').checked = app.settings.autoSave;
      document.getElementById('theme-selector').value = app.settings.theme;
      document.getElementById('production-rules').value = app.settings.rules || '';
      
      // Update production rules display
      updateProductionRulesDisplay();
      
      // Apply theme if it exists
      applyTheme(app.settings.theme);
    }
    
    // Update production rules display
    function updateProductionRulesDisplay() {
      if (app.settings.rules && app.settings.rules.trim() !== '') {
        elements.productionRulesContent.innerHTML = app.settings.rules;
      } else {
        elements.productionRulesContent.innerHTML = '<p class="text-gray-500 text-sm">No rules configured. Go to Settings to add production rules.</p>';
      }
    }
    
    // Apply theme
    function applyTheme(theme) {
      const root = document.documentElement;
      
      // Reset all theme classes
      document.body.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-red', 'theme-gray');
      
      // Add selected theme class
      document.body.classList.add(`theme-${theme}`);
      
      // Update header color
      const header = document.querySelector('.header');
      
      if (header) {
        // Remove all color classes
        header.classList.remove(
          'bg-blue-600', 'bg-green-600', 'bg-purple-600', 'bg-red-600', 'bg-gray-600'
        );
        
        // Add appropriate color class
        switch (theme) {
          case 'green':
            header.style.backgroundColor = '#059669';
            break;
          case 'purple':
            header.style.backgroundColor = '#7c3aed';
            break;
          case 'red':
            header.style.backgroundColor = '#dc2626';
            break;
          case 'gray':
            header.style.backgroundColor = '#4b5563';
            break;
          default: // blue
            header.style.backgroundColor = '#2563eb';
            break;
        }
      }
    }
    
    // Update role selectors for costume assignments
    function updateRoleSelectors() {
      // Get all costume role selectors
      const roleSelectors = document.querySelectorAll('.costume-role');
      
      roleSelectors.forEach(selector => {
        const selectedValue = selector.value;
        
        // Clear options
        selector.innerHTML = '<option value="">Select a Role</option>';
        
        // Add main cast roles
        app.mainCast.forEach(castMember => {
          selector.innerHTML += `<option value="${castMember.role}">${castMember.role}</option>`;
        });
        
        // Add swing roles
        app.swings.forEach(swing => {
          selector.innerHTML += `<option value="${swing.role}">${swing.role}</option>`;
        });
        
        // Restore selected value if possible
        if (selectedValue) {
          selector.value = selectedValue;
        }
      });
      
      // Update eligible performers list for special tracks
      updateEligiblePerformersList();
    }
    
    // Update eligible performers list for special tracks
    function updateEligiblePerformersList() {
      const eligiblePerformersList = document.getElementById('eligible-performers-list');
      
      if (!eligiblePerformersList) return;
      
      if (app.mainCast.length === 0 && app.swings.length === 0) {
        eligiblePerformersList.innerHTML = '<p class="text-gray-500 text-sm">No cast members defined yet.</p>';
        return;
      }
      
      let html = '';
      
      // Add main cast
      app.mainCast.forEach((castMember, index) => {
        html += `
          <div class="flex items-center">
            <input type="checkbox" id="eligible-performer-main-${index}" class="eligible-performer" data-type="main" data-index="${index}" data-name="${castMember.actor}">
            <label for="eligible-performer-main-${index}" class="ml-2">${castMember.actor} (${castMember.role})</label>
          </div>
        `;
      });
      
      // Add swings
      app.swings.forEach((swing, index) => {
        html += `
          <div class="flex items-center">
            <input type="checkbox" id="eligible-performer-swing-${index}" class="eligible-performer" data-type="swing" data-index="${index}" data-name="${swing.actor}">
            <label for="eligible-performer-swing-${index}" class="ml-2">${swing.actor} (${swing.role})</label>
          </div>
        `;
      });
      
      eligiblePerformersList.innerHTML = html;
    }
    
    // Build the main cast list for daily operations
    function buildMainCastList() {
      if (!elements.mainCastList) return;
      
      elements.mainCastList.innerHTML = '';
      
      if (app.mainCast.length === 0) {
        elements.mainCastList.innerHTML = '<div class="cast-item"><p class="text-gray-500 text-sm">No cast members configured. Go to Cast Management to add performers.</p></div>';
        return;
      }
      
      app.mainCast.forEach((member, index) => {
        const castItem = document.createElement('div');
        castItem.className = 'cast-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `cast-${index}`;
        checkbox.checked = member.isOff || false;
        
        // Use both click and change events for iOS compatibility
        checkbox.addEventListener('click', () => {
          member.isOff = checkbox.checked;
          processCastAssignments();
        });
        
        checkbox.addEventListener('change', () => {
          member.isOff = checkbox.checked;
          processCastAssignments();
        });
        
        const label = document.createElement('label');
        label.htmlFor = `cast-${index}`;
        label.innerHTML = `<span class="cast-name">${member.actor}</span> (${member.role})`;
        
        castItem.appendChild(checkbox);
        castItem.appendChild(label);
        elements.mainCastList.appendChild(castItem);
      });
    }
    
    // Build the swings list for daily operations
    function buildSwingsList() {
      if (!elements.swingsList) return;
      
      elements.swingsList.innerHTML = '';
      
      if (app.swings.length === 0) {
        elements.swingsList.innerHTML = '<div class="cast-item"><p class="text-gray-500 text-sm">No swings configured. Go to Cast Management to add swings.</p></div>';
        return;
      }
      
      app.swings.forEach((swing, index) => {
        const swingItem = document.createElement('div');
        swingItem.className = 'cast-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `swing-${index}`;
        checkbox.checked = swing.isOff || false;
        
        // Use both click and change events for iOS compatibility
        checkbox.addEventListener('click', () => {
          swing.isOff = checkbox.checked;
          processCastAssignments();
        });
        
        checkbox.addEventListener('change', () => {
          swing.isOff = checkbox.checked;
          processCastAssignments();
        });
        
        const label = document.createElement('label');
        label.htmlFor = `swing-${index}`;
        label.innerHTML = `<span class="cast-name">${swing.actor}</span> (${swing.role})`;
        
        swingItem.appendChild(checkbox);
        swingItem.appendChild(label);
        elements.swingsList.appendChild(swingItem);
      });
    }
    
    // Build the special tracks UI for daily operations
    function buildSpecialTracksUI() {
      if (!elements.specialTracksContainer) return;
      
      elements.specialTracksContainer.innerHTML = '';
      
      if (app.specialTracks.length === 0) {
        return; // Don't show anything if no special tracks
      }
      
      app.specialTracks.forEach((track, trackIndex) => {
        const trackElement = document.createElement('div');
        trackElement.className = 'special-scene-card';
        
        // Find related scene
        const sceneIndex = parseInt(track.sceneIndex);
        const scene = app.scenes[sceneIndex] || { name: 'Unknown Scene', act: 1 };
        const act = scene.act ? app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' } : { number: '?', name: '' };
        
        trackElement.innerHTML = `
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
            Manual Track Assignment
          </h3>
          <div class="special-scene-title">Act ${act.number} - ${scene.name}: "${track.name}"</div>
          <div class="special-scene-subtitle">${track.description || 'Select who will be performing this track:'}</div>
          
          <div id="special-track-performers-${trackIndex}" class="special-track-performers">
            <!-- These checkboxes will be populated by JavaScript -->
          </div>
        `;
        
        elements.specialTracksContainer.appendChild(trackElement);
        
        // Add performers list
        const performersList = document.getElementById(`special-track-performers-${trackIndex}`);
        
        if (track.eligiblePerformers && track.eligiblePerformers.length > 0) {
          track.eligiblePerformers.forEach(performer => {
            // Find this performer in the cast
            let foundPerformer = null;
            
            // Search in main cast
            app.mainCast.forEach(castMember => {
              if (castMember.actor === performer) foundPerformer = castMember;
            });
            
            // Search in swings
            if (!foundPerformer) {
              app.swings.forEach(swing => {
                if (swing.actor === performer) foundPerformer = swing;
              });
            }
            
            if (foundPerformer) {
              const performerItem = document.createElement('div');
              performerItem.className = 'cast-item';
              
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `special-track-${trackIndex}-performer-${performer.replace(/\s+/g, '-')}`;
              
              // Check if this performer is selected for this track
              checkbox.checked = false;
              if (app.currentPerformance.specialAssignments && 
                  app.currentPerformance.specialAssignments[track.name] && 
                  app.currentPerformance.specialAssignments[track.name].includes(performer)) {
                checkbox.checked = true;
              }
              
              checkbox.addEventListener('change', () => {
                updateSpecialTrackAssignments(track.name, performer, checkbox.checked);
              });
              
              const label = document.createElement('label');
              label.htmlFor = `special-track-${trackIndex}-performer-${performer.replace(/\s+/g, '-')}`;
              label.innerHTML = `<span class="cast-name">${performer}</span>${foundPerformer.role ? ` (${foundPerformer.role})` : ''}`;
              
              performerItem.appendChild(checkbox);
              performerItem.appendChild(label);
              performersList.appendChild(performerItem);
            }
          });
        } else {
          performersList.innerHTML = '<p class="text-sm text-gray-500">No eligible performers defined for this track.</p>';
        }
      });
    }
    
    // Update special track assignments
    function updateSpecialTrackAssignments(trackName, performer, isSelected) {
      // Initialize if not exists
      if (!app.currentPerformance.specialAssignments) {
        app.currentPerformance.specialAssignments = {};
      }
      
      if (!app.currentPerformance.specialAssignments[trackName]) {
        app.currentPerformance.specialAssignments[trackName] = [];
      }
      
      // Add or remove performer
      if (isSelected) {
        // Add performer if not already included
        if (!app.currentPerformance.specialAssignments[trackName].includes(performer)) {
          app.currentPerformance.specialAssignments[trackName].push(performer);
        }
      } else {
        // Remove performer
        app.currentPerformance.specialAssignments[trackName] = 
          app.currentPerformance.specialAssignments[trackName].filter(p => p !== performer);
      }
      
      // Update the output
      processCastAssignments();
    }
    
    // Process the cast assignments based on who's off
    function processCastAssignments() {
      // Create working copies of the cast
      let processedCast = JSON.parse(JSON.stringify(app.mainCast));
      let processedSwings = JSON.parse(JSON.stringify(app.swings));
      
      // Track which performers are already assigned to a role or marked as off
      const assignedPerformers = {};
      
      // First, mark ALL off performers as unavailable (both main cast and swings)
      // This ensures anyone who's off cannot be used for ANY role
      processedCast.forEach(member => {
        if (member.isOff) {
          assignedPerformers[member.actor] = true;
        }
      });
      
      processedSwings.forEach(swing => {
        if (swing.isOff) {
          assignedPerformers[swing.actor] = true;
        }
      });
      
      // Also mark performers assigned to special tracks as unavailable
      if (app.currentPerformance.specialAssignments) {
        Object.values(app.currentPerformance.specialAssignments).forEach(performers => {
          performers.forEach(performer => {
            assignedPerformers[performer] = true;
          });
        });
      }
      
      // Track cascade of roles that need covering due to actors being reassigned
      const rolesToCover = [];
      
      // First pass: identify all initially off performers and add their roles to the cover list
      processedCast.forEach(castMember => {
        if (castMember.isOff) {
          rolesToCover.push({
            role: castMember.role,
            originalActor: castMember.actor,
            needsCover: true,
            coveredBy: null
          });
        }
      });
      
      // Process the cascade of roles needing covers until we've handled all or can't find more covers
      let changesMade = true;
      let iterations = 0;
      const MAX_ITERATIONS = 10; // Safety to prevent infinite loops
      
      while (changesMade && rolesToCover.some(r => r.needsCover) && iterations < MAX_ITERATIONS) {
        iterations++;
        changesMade = false;
        
        // Go through each role that still needs a cover
        for (let i = 0; i < rolesToCover.length; i++) {
          if (!rolesToCover[i].needsCover) continue;
          
          // Find the original cast member for this role
          const roleToFill = rolesToCover[i].role;
          const originalCastMember = processedCast.find(m => m.role === roleToFill);
          
          if (!originalCastMember) continue;
          
          // Try to assign an understudy
          let assigned = false;
          
          // Helper function to check if an understudy is available and assign them
          const tryAssignUnderstudy = (understudyName) => {
            // If the understudy exists, isn't already assigned, and isn't off
            if (understudyName && !assignedPerformers[understudyName]) {
              rolesToCover[i].coveredBy = understudyName;
              assignedPerformers[understudyName] = true; // Mark as assigned
              rolesToCover[i].needsCover = false;
              assigned = true;
              changesMade = true;
              
              // Check if the understudy was originally playing another role that now needs covering
              const understudyOriginalRole = processedCast.find(m => m.actor === understudyName);
              if (understudyOriginalRole && !rolesToCover.some(r => r.role === understudyOriginalRole.role)) {
                rolesToCover.push({
                  role: understudyOriginalRole.role,
                  originalActor: understudyOriginalRole.actor,
                  needsCover: true,
                  coveredBy: null
                });
              }
              return true;
            }
            return false;
          };
          
          // Try first understudy
          if (!assigned && originalCastMember.understudy1) {
            tryAssignUnderstudy(originalCastMember.understudy1);
          }
          
          // Try second understudy if first isn't available
          if (!assigned && originalCastMember.understudy2) {
            tryAssignUnderstudy(originalCastMember.understudy2);
          }
          
          // Try third understudy if needed
          if (!assigned && originalCastMember.understudy3) {
            tryAssignUnderstudy(originalCastMember.understudy3);
          }
        }
      }
      
      // Update the processed cast with all the coverage decisions
      rolesToCover.forEach(roleCoverage => {
        const castIndex = processedCast.findIndex(m => m.role === roleCoverage.role);
        if (castIndex !== -1) {
          processedCast[castIndex].coveringActor = roleCoverage.coveredBy || "⚠️ UNCOVERED ⚠️";
          
          // If this is an originally off performer, mark them as off
          if (roleCoverage.originalActor === processedCast[castIndex].actor) {
            processedCast[castIndex].isOff = true;
          } else {
            // This is a cascading coverage situation - mark the role as needing cover but not the original actor as off
            processedCast[castIndex].needsCover = true;
          }
        }
      });
      
      // Set any remaining roles to have their original actor if not otherwise assigned
      processedCast.forEach(castMember => {
        if (!castMember.isOff && !castMember.needsCover) {
          castMember.coveringActor = castMember.actor;
        }
      });
      
      dailyCast = processedCast;
      
      // Generate summary of who's off and who's covering, including the cascade
      const offCast = processedCast.filter(member => member.isOff);
      const cascadedCoverage = processedCast.filter(member => !member.isOff && member.needsCover);
      const offSwings = processedSwings.filter(swing => swing.isOff);
      const uncoveredRoles = processedCast.filter(member => (member.isOff || member.needsCover) && 
                                                           (member.coveringActor === null || 
                                                            member.coveringActor === undefined || 
                                                            member.coveringActor.includes('UNCOVERED')));
      
      let summary = "";
      if (offCast.length > 0) {
        summary += "Cast members off:\n";
        offCast.forEach(member => {
          summary += `• ${member.actor} (${member.role}) - covered by ${member.coveringActor || 'UNCOVERED'}\n`;
        });
      }
      
      if (cascadedCoverage.length > 0) {
        summary += "\nCascade coverage:\n";
        cascadedCoverage.forEach(member => {
          summary += `• ${member.actor} moved to another role - ${member.role} covered by ${member.coveringActor || 'UNCOVERED'}\n`;
        });
      }
      
      if (offSwings.length > 0) {
        summary += "\nSwings off:\n";
        offSwings.forEach(swing => {
          summary += `• ${swing.actor} (${swing.role})\n`;
        });
      }
      
      // Add special track assignments
      if (app.currentPerformance.specialAssignments) {
        Object.entries(app.currentPerformance.specialAssignments).forEach(([trackName, performers]) => {
          if (performers.length > 0) {
            summary += `\nSpecial Track - ${trackName}:\n`;
            performers.forEach(performer => {
              summary += `• ${performer}\n`;
            });
          }
        });
      }
      
      if (uncoveredRoles.length > 0) {
        summary += "\n⚠️ WARNING - UNCOVERED ROLES ⚠️\n";
        uncoveredRoles.forEach(role => {
          summary += `• ${role.role} needs coverage - all understudies unavailable\n`;
        });
      }
      
      if (offCast.length === 0 && cascadedCoverage.length === 0 && offSwings.length === 0 && 
          (!app.currentPerformance.specialAssignments || Object.keys(app.currentPerformance.specialAssignments).length === 0)) {
        summary = "All cast members are performing today.";
      }
      
      offSummary = summary;
      
      // Update the UI with the processed cast and summary
      updateDailyCastTable();
      updateOffSummary();
      
      // Save current performance data if auto-save is enabled
      if (app.settings.autoSave) {
        app.currentPerformance.date = document.getElementById('show-date').value;
        app.currentPerformance.time = document.getElementById('performance-time').value;
        app.currentPerformance.venue = document.getElementById('venue').value;
        app.currentPerformance.notes = document.getElementById('performance-notes').value;
        
        // Save off performers from the UI
        app.currentPerformance.offPerformers = [];
        
        app.mainCast.forEach(member => {
          if (member.isOff) {
            app.currentPerformance.offPerformers.push({
              type: 'main',
              actor: member.actor,
              role: member.role
            });
          }
        });
        
        app.swings.forEach(swing => {
          if (swing.isOff) {
            app.currentPerformance.offPerformers.push({
              type: 'swing',
              actor: swing.actor,
              role: swing.role
            });
          }
        });
        
        saveToLocalStorage();
      }
    }
    
    // Update the daily cast table
    function updateDailyCastTable() {
      if (!elements.dailyCastTable) return;
      
      elements.dailyCastTable.innerHTML = '';
      
      if (dailyCast.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 3;
        cell.className = 'text-center text-gray-500 text-sm';
        cell.textContent = 'No cast members configured';
        row.appendChild(cell);
        elements.dailyCastTable.appendChild(row);
        return;
      }
      
      dailyCast.forEach((member) => {
        const row = document.createElement('tr');
        if (member.isOff) {
          row.className = 'row-off';
        } else if (member.needsCover) {
          row.className = 'row-cascade';
        }
        
        const roleCell = document.createElement('td');
        roleCell.className = 'font-medium';
        roleCell.textContent = member.role;
        
        const actorCell = document.createElement('td');
        if (member.coveringActor && member.coveringActor.includes('UNCOVERED')) {
          actorCell.className = 'uncovered';
        }
        actorCell.textContent = member.coveringActor || member.actor;
        
        const statusCell = document.createElement('td');
        const statusBadge = document.createElement('span');
        statusBadge.className = 'status-badge';
        
        if (member.isOff) {
          statusBadge.classList.add('status-off');
          statusBadge.textContent = 'Original actor off';
        } else if (member.needsCover) {
          statusBadge.classList.add('status-cascade');
          statusBadge.textContent = 'Cascade coverage';
        } else {
          statusBadge.classList.add('status-original');
          statusBadge.textContent = 'Original actor';
        }
        
        statusCell.appendChild(statusBadge);
        
        row.appendChild(roleCell);
        row.appendChild(actorCell);
        row.appendChild(statusCell);
        elements.dailyCastTable.appendChild(row);
      });
    }
    
    // Update the off summary text
    function updateOffSummary() {
      if (!elements.offSummary) return;
      
      elements.offSummary.textContent = offSummary;
    }
    
    // Generate and display PDF
    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const showDate = document.getElementById('show-date').value;
      const performanceTime = document.getElementById('performance-time').value;
      const venue = document.getElementById('venue').value;
      const notes = document.getElementById('performance-notes').value;
      
      // Get actors who are off or covering
      const coveringActors = dailyCast
        .filter(member => member.isOff || member.needsCover)
        .map(member => ({
          name: member.coveringActor,
          originalRole: member.role,
          covering: member.isOff ? member.actor : member.role
        }));
      
      // Create the PDF content in the modal
      const pdfView = elements.pdfView;
      
      let pdfContent = `
        <div class="pdf-container">
          <div class="pdf-header">
            <div class="pdf-logo-container">
              <div class="pdf-logo"></div>
            </div>
            <div class="pdf-title">${app.production.name || 'Production'} - OFF SHEET</div>
            <div class="pdf-subtitle">Date: ${formatDate(showDate)} | Performance: ${performanceTime} | Venue: ${venue}</div>
          </div>
          
          <table class="pdf-table">
            <thead>
              <tr>
                <th style="width: 200px;">Scene/Role</th>
                ${coveringActors.map(actor => 
                  `<th>${actor.name}<br><span style="font-size: 9px;">${actor.covering ? 
                    `(covering ${actor.covering})` : 
                    ''}</span></th>`
                ).join('')}
              </tr>
            </thead>
            <tbody>`;
      
      // Group scenes by act
      const scenesByAct = {};
      
      app.scenes.forEach(scene => {
        const actNum = scene.act;
        if (!scenesByAct[actNum]) {
          scenesByAct[actNum] = [];
        }
        scenesByAct[actNum].push(scene);
      });
      
      // Sort acts numerically
      const sortedActs = Object.keys(scenesByAct).sort((a, b) => parseInt(a) - parseInt(b));
      
      // For each act, add a header and then all scenes in that act
      sortedActs.forEach(actNum => {
        const act = app.acts.find(a => a.number === parseInt(actNum)) || { number: actNum, name: '' };
        
        pdfContent += `
          <tr class="section-header">
            <td colspan="${coveringActors.length + 1}">Act ${act.number}${act.name ? ': ' + act.name : ''}</td>
          </tr>`;
        
        // Add each scene in this act
        scenesByAct[actNum].forEach(scene => {
          pdfContent += `
            <tr>
              <td>${scene.name}${scene.song ? `<br>${scene.song}` : ''}</td>`;
          
          // For each covering actor, only show their name when they have a costume for this scene
          coveringActors.forEach(actor => {
            let costumeInfo = "";
            let cellClass = "";
            
            // Find which role they're covering
            const coveringRole = dailyCast.find(m => m.coveringActor === actor.name)?.role;
            
            // If we found the role and it has a costume in this scene
            if (coveringRole && scene.costumes && scene.costumes[coveringRole]) {
              costumeInfo = scene.costumes[coveringRole];
              // Add the actor's name in bold, followed by the costume info (only when they have a costume)
              pdfContent += `<td><strong>${actor.name}</strong><br><span class="costume-info">${costumeInfo}</span></td>`;
            } else {
              // Empty cell (actor isn't in this scene)
              pdfContent += `<td class="no-costume"></td>`;
            }
          });
          
          pdfContent += `</tr>`;
        });
      });
      
      // Add special tracks section if any exist and have assigned performers
      if (app.currentPerformance.specialAssignments && Object.keys(app.currentPerformance.specialAssignments).length > 0) {
        pdfContent += `
          <tr class="section-header">
            <td colspan="${coveringActors.length + 1}">Special Track Assignments</td>
          </tr>`;
        
        Object.entries(app.currentPerformance.specialAssignments).forEach(([trackName, performers]) => {
          if (performers.length > 0) {
            // Find the special track
            const specialTrack = app.specialTracks.find(track => track.name === trackName);
            
            if (specialTrack) {
              // Find the scene
              const sceneIndex = parseInt(specialTrack.sceneIndex);
              const scene = app.scenes[sceneIndex] || { name: 'Unknown Scene', act: 1 };
              const act = scene.act ? app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' } : { number: '?', name: '' };
              
              pdfContent += `
                <tr>
                  <td class="manual-override">
                    <strong>${trackName}</strong><br>
                    <span class="costume-info">Act ${act.number} - ${scene.name}</span>
                  </td>`;
              
              // Empty cells for track header row
              coveringActors.forEach(() => {
                pdfContent += `<td class="no-costume"></td>`;
              });
              
              pdfContent += `</tr>`;
              
              // Add a row for each performer
              performers.forEach(performer => {
                pdfContent += `
                  <tr>
                    <td class="manual-override">
                      <strong>${performer}</strong>
                    </td>`;
                
                // Empty cells for each performer row
                coveringActors.forEach(() => {
                  pdfContent += `<td class="no-costume"></td>`;
                });
                
                pdfContent += `</tr>`;
              });
            }
          }
        });
      }
      
      pdfContent += `
        </tbody>
      </table>
      
      <div class="pdf-notes">
        <h3>NOTES:</h3>
        
        ${app.settings.rules ? `
          <div style="margin-bottom: 15px;">
            ${app.settings.rules}
          </div>
        ` : ''}
        
        ${notes ? `
          <p style="font-weight: bold; margin-top: 10px; margin-bottom: 5px;">Performance Notes:</p>
          <p style="white-space: pre-line;">${notes}</p>
        ` : ''}
        
        ${dailyCast.some(member => member.coveringActor && member.coveringActor.includes('UNCOVERED')) ? `
          <div class="pdf-warning">
            <h3 style="margin-top: 0; color: #e65100;">⚠️ WARNING: UNCOVERED ROLES</h3>
            <p>The following roles have no available coverage:</p>
            <ul>
              ${dailyCast
                .filter(member => member.coveringActor && member.coveringActor.includes('UNCOVERED'))
                .map(member => `<li>${member.role} (normally ${member.actor})</li>`)
                .join('')}
            </ul>
          </div>
        ` : ''}
        
        ${app.currentPerformance.specialAssignments && Object.keys(app.currentPerformance.specialAssignments).length > 0 ? `
          <div style="margin-top: 15px; padding: 10px; border: 2px solid #10b981; background-color: #ecfdf5;">
            <h3 style="margin-top: 0; color: #047857;">Special Track Assignments:</h3>
            ${Object.entries(app.currentPerformance.specialAssignments).map(([trackName, performers]) => `
              ${performers.length > 0 ? `
                <div style="margin-bottom: 10px;">
                  <div style="font-weight: bold;">${trackName}</div>
                  <ul>
                    ${performers.map(performer => `<li>${performer}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            `).join('')}
          </div>
        ` : ''}
      </div>
      
      <div style="border: 1px solid #000; padding: 10px; margin-top: 15px;">
        <h3 style="margin-top: 0;">Today's Cast Summary (${formatDate(showDate)}):</h3>
        <pre style="white-space: pre-line; margin: 0; font-family: Arial, sans-serif; font-size: 12px;">${offSummary}</pre>
      </div>
    </div>
  `;
  
      pdfView.innerHTML = pdfContent;
      
      // Show the modal
      elements.pdfModal.style.display = 'flex';
    }
    
    // Download the PDF
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      // Create loading message
      const loadingMessage = document.createElement('div');
      loadingMessage.style.position = 'fixed';
      loadingMessage.style.top = '0';
      loadingMessage.style.left = '0';
      loadingMessage.style.width = '100%';
      loadingMessage.style.height = '100%';
      loadingMessage.style.backgroundColor = 'rgba(0,0,0,0.5)';
      loadingMessage.style.display = 'flex';
      loadingMessage.style.justifyContent = 'center';
      loadingMessage.style.alignItems = 'center';
      loadingMessage.style.zIndex = '9999';
      loadingMessage.style.color = 'white';
      loadingMessage.style.fontSize = '20px';
      loadingMessage.innerHTML = 'Generating PDF, please wait...';
      document.body.appendChild(loadingMessage);
      
      // Get the PDF content element
      const pdfContent = elements.pdfView;
      
      // Use setTimeout to allow the loading message to appear
      setTimeout(function() {
        // Convert HTML to canvas and then to PDF
        html2canvas(pdfContent, {
          scale: 2,  // Higher scale for better quality
          useCORS: true,
          logging: false,
          allowTaint: true
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          
          // Calculate the page size and scaling
          const imgWidth = 210;  // A4 width in mm
          const pageHeight = 297;  // A4 height in mm
          const imgHeight = canvas.height * imgWidth / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;
          
          // Add first page
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          
          // Add additional pages if needed
          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          
          // Download the PDF
          const showDate = document.getElementById('show-date').value;
          const productionName = app.production.name || 'Production';
          pdf.save(`${productionName}-Off-Sheet-${showDate}.pdf`);
          
          // Remove loading message
          document.body.removeChild(loadingMessage);
        });
      }, 100);
    }
    
    // Generate printable off sheet
    function generatePrintableOffSheet() {
      const showDate = document.getElementById('show-date').value;
      const performanceTime = document.getElementById('performance-time').value;
      const venue = document.getElementById('venue').value;
      const notes = document.getElementById('performance-notes').value;
      
      const printArea = document.getElementById('print-area');
      
      // Build the HTML for the printable sheet
      let printHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
          <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
            <h1 style="margin: 0 0 5px 0; font-size: 24px;">${app.production.name || 'Production'} - OFF SHEET</h1>
            <p>Date: ${formatDate(showDate)} | Performance: ${performanceTime} | Venue: ${venue}</p>
          </div>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">OFF</th>
                ${dailyCast.filter(member => member.isOff || member.needsCover).map((member) => `
                  <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">
                    ${member.coveringActor}<br>
                    <span style="font-size: 12px;">
                      ${member.isOff 
                        ? `(covering for ${member.actor})` 
                        : `(covering ${member.role})`}
                    </span>
                  </th>
                `).join('')}
              </tr>
            </thead>
            <tbody>`;
      
      // Group scenes by act
      const scenesByAct = {};
      
      app.scenes.forEach(scene => {
        const actNum = scene.act;
        if (!scenesByAct[actNum]) {
          scenesByAct[actNum] = [];
        }
        scenesByAct[actNum].push(scene);
      });
      
      // Sort acts numerically
      const sortedActs = Object.keys(scenesByAct).sort((a, b) => parseInt(a) - parseInt(b));
      
      // For each act, add a header and then all scenes in that act
      sortedActs.forEach(actNum => {
        const act = app.acts.find(a => a.number === parseInt(actNum)) || { number: actNum, name: '' };
        
        printHTML += `
          <tr>
            <td colspan="${dailyCast.filter(member => member.isOff || member.needsCover).length + 1}" 
                style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; font-weight: bold;">
              Act ${act.number}${act.name ? ': ' + act.name : ''}
            </td>
          </tr>`;
        
        // Add each scene in this act
        scenesByAct[actNum].forEach(scene => {
          printHTML += `
            <tr>
              <td style="border: 1px solid #ccc; padding: 8px;">
                ${scene.name}${scene.song ? `<br>${scene.song}` : ''}
              </td>
              ${dailyCast.filter(member => member.isOff || member.needsCover).map(() => `
                <td style="border: 1px solid #ccc; padding: 8px;"></td>
              `).join('')}
            </tr>`;
        });
      });
      
      // Add special track assignments if applicable
      if (app.currentPerformance.specialAssignments && Object.keys(app.currentPerformance.specialAssignments).length > 0) {
        printHTML += `
          <tr>
            <td colspan="${dailyCast.filter(member => member.isOff || member.needsCover).length + 1}" 
                style="border: 1px solid #ccc; padding: 8px; background-color: #dcfce7; font-weight: bold;">
              Special Track Assignments
            </td>
          </tr>`;
        
        Object.entries(app.currentPerformance.specialAssignments).forEach(([trackName, performers]) => {
          if (performers.length > 0) {
            printHTML += `
              <tr>
                <td style="border: 1px solid #ccc; padding: 8px; background-color: #f0fff4; font-weight: bold;">
                  ${trackName}
                </td>
                ${dailyCast.filter(member => member.isOff || member.needsCover).map(() => `
                  <td style="border: 1px solid #ccc; padding: 8px;"></td>
                `).join('')}
              </tr>`;
            
            performers.forEach(performer => {
              printHTML += `
                <tr>
                  <td style="border: 1px solid #ccc; padding: 8px; background-color: #f0fff4; padding-left: 20px;">
                    - ${performer}
                  </td>
                  ${dailyCast.filter(member => member.isOff || member.needsCover).map(() => `
                    <td style="border: 1px solid #ccc; padding: 8px;"></td>
                  `).join('')}
                </tr>`;
            });
          }
        });
      }
      
      printHTML += `
            </tbody>
          </table>
          
          <div style="border: 1px solid #ccc; padding: 15px; background-color: #f0f0f0; margin-bottom: 15px;">
            <h3 style="margin-top: 0; margin-bottom: 10px;">NOTES:</h3>
            
            ${app.settings.rules ? `
              <div style="margin-bottom: 15px;">
                ${app.settings.rules}
              </div>
            ` : ''}
            
            ${notes ? `
              <p style="font-weight: bold; margin-top: 10px; margin-bottom: 5px;">Performance Notes:</p>
              <p style="white-space: pre-line;">${notes}</p>
            ` : ''}
          </div>
          
          <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px;">
            <h3 style="margin-top: 0; margin-bottom: 10px;">Today's Cast Summary (${formatDate(showDate)}):</h3>
            <pre style="white-space: pre-line; margin: 0; font-family: Arial, sans-serif;">${offSummary}</pre>
          </div>
        </div>
      `;
      
      printArea.innerHTML = printHTML;
      
      window.print();
    }
    
    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-UK', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    }
    
    // Save the current configuration
    function saveConfiguration() {
      // Update app state with current performance data
      app.currentPerformance.date = document.getElementById('show-date').value;
      app.currentPerformance.time = document.getElementById('performance-time').value;
      app.currentPerformance.venue = document.getElementById('venue').value;
      app.currentPerformance.notes = document.getElementById('performance-notes').value;
      
      const dataStr = JSON.stringify(app);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `${app.production.name || 'production'}-off-sheet-${app.currentPerformance.date}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showToast("Configuration saved successfully!");
    }
    
    // Load a saved configuration
    function loadConfiguration(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // Update current performance data
          document.getElementById('show-date').value = data.currentPerformance?.date || new Date().toISOString().split('T')[0];
          document.getElementById('performance-time').value = data.currentPerformance?.time || '19:30';
          document.getElementById('venue').value = data.currentPerformance?.venue || '';
          document.getElementById('performance-notes').value = data.currentPerformance?.notes || '';
          
          // Update cast off status from loaded data
          if (data.mainCast && data.mainCast.length > 0) {
            data.mainCast.forEach((savedMember, index) => {
              if (index < app.mainCast.length) {
                app.mainCast[index].isOff = savedMember.isOff || false;
              }
            });
          }
          
          // Update swings off status
          if (data.swings && data.swings.length > 0) {
            data.swings.forEach((savedSwing, index) => {
              if (index < app.swings.length) {
                app.swings[index].isOff = savedSwing.isOff || false;
              }
            });
          }
          
          // Update special track assignments
          if (data.currentPerformance && data.currentPerformance.specialAssignments) {
            app.currentPerformance.specialAssignments = data.currentPerformance.specialAssignments;
          }
          
          // Rebuild the UI
          buildMainCastList();
          buildSwingsList();
          buildSpecialTracksUI();
          processCastAssignments();
          
          showToast("Performance configuration loaded!");
          
        } catch (error) {
          console.error('Error loading file:', error);
          showToast('Error loading file', true);
        }
      };
      reader.readAsText(file);
    }
    
    // Export production configuration
    function exportProductionConfiguration() {
      const dataStr = JSON.stringify(app);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `${app.production.name || 'production'}-configuration.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showToast("Production configuration exported!");
    }
    
    // Import production configuration
    function importProductionConfiguration(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // Show confirmation dialog
          showConfirmationDialog(
            "Import Production Configuration",
            "This will overwrite your current production configuration. Are you sure you want to proceed?",
            () => {
              // Proceed with import
              app.production = data.production || app.production;
              app.mainCast = data.mainCast || [];
              app.swings = data.swings || [];
              app.acts = data.acts || [];
              app.scenes = data.scenes || [];
              app.specialTracks = data.specialTracks || [];
              app.settings = data.settings || app.settings;
              
              // Current performance is kept separate to avoid overwriting today's setup
              
              // Save to localStorage
              saveToLocalStorage();
              
              // Update UI
              updateProductionInfo();
              updateCastList();
              updateSwingsList();
              updateActsList();
              updateScenesList();
              updateSpecialTracksList();
              updateSettingsUI();
              
              // Rebuild the daily operations UI
              buildMainCastList();
              buildSwingsList();
              buildSpecialTracksUI();
              processCastAssignments();
              
              showToast("Production configuration imported successfully!");
            }
          );
          
        } catch (error) {
          console.error('Error importing production configuration:', error);
          showToast('Error importing production configuration', true);
        }
      };
      reader.readAsText(file);
    }
    
    // Reset production configuration
    function resetProductionConfiguration() {
      showConfirmationDialog(
        "Reset Production Configuration",
        "This will delete all your production data including cast, scenes, and settings. This action cannot be undone. Are you sure you want to proceed?",
        () => {
          // Reset app to default state
          app.production = {
            name: "",
            subtitle: "",
            defaultVenue: "",
            defaultTime: "19:30",
            description: ""
          };
          app.mainCast = [];
          app.swings = [];
          app.acts = [];
          app.scenes = [];
          app.specialTracks = [];
          app.settings = {
            autoSave: true,
            theme: "blue",
            rules: ""
          };
          
          // Keep current performance data
          app.currentPerformance = {
            date: document.getElementById('show-date').value,
            time: document.getElementById('performance-time').value,
            venue: "",
            notes: "",
            offPerformers: [],
            specialAssignments: {}
          };
          
          // Save to localStorage
          saveToLocalStorage();
          
          // Update UI
          updateProductionInfo();
          updateCastList();
          updateSwingsList();
          updateActsList();
          updateScenesList();
          updateSpecialTracksList();
          updateSettingsUI();
          
          // Rebuild the daily operations UI
          buildMainCastList();
          buildSwingsList();
          buildSpecialTracksUI();
          processCastAssignments();
          
          showToast("Production configuration reset successfully!");
        }
      );
    }
    
    // Close the PDF modal
    function closePDFModal() {
      elements.pdfModal.style.display = 'none';
    }
    
    // Print the PDF
    function printPDF() {
      window.print();
    }
    
    // Show toast notification
    function showToast(message, isError = false) {
      elements.toast.classList.remove('show', 'error');
      
      if (isError) {
        elements.toast.classList.add('error');
      }
      
      elements.toastMessage.textContent = message;
      elements.toast.classList.add('show');
      
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, 3000);
    }
    
    // Show confirmation dialog
    function showConfirmationDialog(title, message, onConfirm) {
      const confirmModal = elements.confirmModal;
      const confirmModalTitle = document.getElementById('confirm-modal-title');
      const confirmModalContent = elements.confirmModalContent;
      
      confirmModalTitle.textContent = title;
      confirmModalContent.innerHTML = `<p>${message}</p>`;
      
      confirmModal.style.display = 'flex';
      
      // Set up confirm action
      document.getElementById('confirm-action').onclick = () => {
        onConfirm();
        confirmModal.style.display = 'none';
      };
      
      // Set up cancel action
      document.getElementById('cancel-confirm').onclick = 
      document.getElementById('close-confirm-modal').onclick = () => {
        confirmModal.style.display = 'none';
      };
    }
    
    // Show edit modal for a cast member
    function editCastMember(index) {
      const castMember = app.mainCast[index];
      const editModal = elements.editModal;
      const editModalTitle = document.getElementById('edit-modal-title');
      const editModalContent = elements.editModalContent;
      
      editModalTitle.textContent = `Edit Role: ${castMember.role}`;
      
      editModalContent.innerHTML = `
        <div class="p-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="field">
              <label for="edit-role-name">Role Name</label>
              <input type="text" id="edit-role-name" value="${castMember.role || ''}">
            </div>
            
            <div class="field">
              <label for="edit-role-type">Role Type</label>
              <select id="edit-role-type">
                <option value="lead" ${castMember.type === 'lead' ? 'selected' : ''}>Lead</option>
                <option value="supporting" ${castMember.type === 'supporting' ? 'selected' : ''}>Supporting</option>
                <option value="ensemble" ${castMember.type === 'ensemble' ? 'selected' : ''}>Ensemble</option>
                <option value="featured" ${castMember.type === 'featured' ? 'selected' : ''}>Featured Ensemble</option>
                <option value="other" ${castMember.type === 'other' ? 'selected' : ''}>Other</option>
              </select>
            </div>
          </div>
          
          <div class="field mt-2">
            <label for="edit-role-actor">Default Performer</label>
            <input type="text" id="edit-role-actor" value="${castMember.actor || ''}">
          </div>
          
          <div class="grid grid-cols-3 gap-4 mt-2">
            <div class="field">
              <label for="edit-role-understudy1">1st Understudy</label>
              <input type="text" id="edit-role-understudy1" value="${castMember.understudy1 || ''}">
            </div>
            
            <div class="field">
              <label for="edit-role-understudy2">2nd Understudy</label>
              <input type="text" id="edit-role-understudy2" value="${castMember.understudy2 || ''}">
            </div>
            
            <div class="field">
              <label for="edit-role-understudy3">3rd Understudy</label>
              <input type="text" id="edit-role-understudy3" value="${castMember.understudy3 || ''}">
            </div>
          </div>
        </div>
      `;
      
      editModal.style.display = 'flex';
      
      // Set up save action
      document.getElementById('save-edit').onclick = () => {
        // Update cast member data
        castMember.role = document.getElementById('edit-role-name').value;
        castMember.type = document.getElementById('edit-role-type').value;
        castMember.actor = document.getElementById('edit-role-actor').value;
        castMember.understudy1 = document.getElementById('edit-role-understudy1').value;
        castMember.understudy2 = document.getElementById('edit-role-understudy2').value;
        castMember.understudy3 = document.getElementById('edit-role-understudy3').value;
        
        // Save to localStorage if auto-save is enabled
        if (app.settings.autoSave) {
          saveToLocalStorage();
        }
        
        // Update UI
        updateCastList();
        
        // Close modal
        editModal.style.display = 'none';
        
        showToast("Role updated successfully!");
      };
      
      // Set up cancel action
      document.getElementById('cancel-edit').onclick = 
      document.getElementById('close-edit-modal').onclick = () => {
        editModal.style.display = 'none';
      };
    }
    
    // Show confirmation dialog for deleting a cast member
    function confirmDeleteCastMember(index) {
      const castMember = app.mainCast[index];
      
      showConfirmationDialog(
        "Delete Role",
        `Are you sure you want to delete the role "${castMember.role}" played by "${castMember.actor}"?`,
        () => {
          // Remove cast member
          app.mainCast.splice(index, 1);
          
          // Save to localStorage if auto-save is enabled
          if (app.settings.autoSave) {
            saveToLocalStorage();
          }
          
          // Update UI
          updateCastList();
          
          showToast("Role deleted successfully!");
        }
      );
    }
    
    // Show edit modal for a swing
    function editSwing(index) {
      const swing = app.swings[index];
      const editModal = elements.editModal;
      const editModalTitle = document.getElementById('edit-modal-title');
      const editModalContent = elements.editModalContent;
      
      editModalTitle.textContent = `Edit Swing: ${swing.actor}`;
      
      editModalContent.innerHTML = `
        <div class="p-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="field">
              <label for="edit-swing-role">Swing Role/Track</label>
              <input type="text" id="edit-swing-role" value="${swing.role || ''}">
            </div>
            
            <div class="field">
              <label for="edit-swing-actor">Performer Name</label>
              <input type="text" id="edit-swing-actor" value="${swing.actor || ''}">
            </div>
          </div>
          
          <div class="field mt-2">
            <label for="edit-swing-notes">Cover Notes</label>
            <textarea id="edit-swing-notes" rows="2">${swing.notes || ''}</textarea>
          </div>
          
          <div class="field mt-2">
            <label for="edit-swing-roles">Covers Roles (Comma separated)</label>
            <input type="text" id="edit-swing-roles" value="${swing.coversRoles || ''}">
          </div>
        </div>
      `;
      
      editModal.style.display = 'flex';
      
      // Set up save action
      document.getElementById('save-edit').onclick = () => {
        // Update swing data
        swing.role = document.getElementById('edit-swing-role').value;
        swing.actor = document.getElementById('edit-swing-actor').value;
        swing.notes = document.getElementById('edit-swing-notes').value;
        swing.coversRoles = document.getElementById('edit-swing-roles').value;
        
        // Save to localStorage if auto-save is enabled
        if (app.settings.autoSave) {
          saveToLocalStorage();
        }
        
        // Update UI
        updateSwingsList();
        
        // Close modal
        editModal.style.display = 'none';
        
        showToast("Swing updated successfully!");
      };
      
      // Set up cancel action
      document.getElementById('cancel-edit').onclick = 
      document.getElementById('close-edit-modal').onclick = () => {
        editModal.style.display = 'none';
      };
    }
    
    // Show confirmation dialog for deleting a swing
    function confirmDeleteSwing(index) {
      const swing = app.swings[index];
      
      showConfirmationDialog(
        "Delete Swing",
        `Are you sure you want to delete the swing "${swing.actor}" (${swing.role})?`,
        () => {
          // Remove swing
          app.swings.splice(index, 1);
          
          // Save to localStorage if auto-save is enabled
          if (app.settings.autoSave) {
            saveToLocalStorage();
          }
          
          // Update UI
          updateSwingsList();
          
          showToast("Swing deleted successfully!");
        }
      );
    }
    
    // Show edit modal for an act
    function editAct(index) {
      const act = app.acts[index];
      const editModal = elements.editModal;
      const editModalTitle = document.getElementById('edit-modal-title');
      const editModalContent = elements.editModalContent;
      
      editModalTitle.textContent = `Edit Act ${act.number}`;
      
      editModalContent.innerHTML = `
        <div class="p-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="field">
              <label for="edit-act-number">Act Number</label>
              <input type="number" id="edit-act-number" min="1" value="${act.number || 1}">
            </div>
            
            <div class="field">
              <label for="edit-act-name">Act Name (Optional)</label>
              <input type="text" id="edit-act-name" value="${act.name || ''}">
            </div>
          </div>
        </div>
      `;
      
      editModal.style.display = 'flex';
      
      // Set up save action
      document.getElementById('save-edit').onclick = () => {
        // Update act data
        const oldNumber = act.number;
        const newNumber = parseInt(document.getElementById('edit-act-number').value);
        act.number = newNumber;
        act.name = document.getElementById('edit-act-name').value;
        
        // Update all scenes associated with this act if number changed
        if (oldNumber !== newNumber) {
          app.scenes.forEach(scene => {
            if (scene.act === oldNumber) {
              scene.act = newNumber;
            }
          });
        }
        
        // Save to localStorage if auto-save is enabled
        if (app.settings.autoSave) {
          saveToLocalStorage();
        }
        
        // Update UI
        updateActsList();
        updateScenesList();
        
        // Close modal
        editModal.style.display = 'none';
        
        showToast("Act updated successfully!");
      };
      
      // Set up cancel action
      document.getElementById('cancel-edit').onclick = 
      document.getElementById('close-edit-modal').onclick = () => {
        editModal.style.display = 'none';
      };
    }
    
    // Show confirmation dialog for deleting an act
    function confirmDeleteAct(index) {
      const act = app.acts[index];
      
      const associatedScenes = app.scenes.filter(scene => scene.act === act.number);
      
      let message = `Are you sure you want to delete Act ${act.number}${act.name ? ': ' + act.name : ''}?`;
      
      if (associatedScenes.length > 0) {
        message += `\n\nThis will also delete ${associatedScenes.length} scene(s) associated with this act.`;
      }
      
      showConfirmationDialog(
        "Delete Act",
        message,
        () => {
          // Remove act
          app.acts.splice(index, 1);
          
          // Remove associated scenes
          app.scenes = app.scenes.filter(scene => scene.act !== act.number);
          
          // Save to localStorage if auto-save is enabled
          if (app.settings.autoSave) {
            saveToLocalStorage();
          }
          
          // Update UI
          updateActsList();
          updateScenesList();
          
          showToast("Act deleted successfully!");
        }
      );
    }
    
    // Show edit modal for a scene
    function editScene(index) {
      const scene = app.scenes[index];
      const editModal = elements.editModal;
      const editModalTitle = document.getElementById('edit-modal-title');
      const editModalContent = elements.editModalContent;
      
      editModalTitle.textContent = `Edit Scene: ${scene.name}`;
      
      // Prepare act options
      let actOptions = '<option value="">Select an Act</option>';
      app.acts.forEach(act => {
        actOptions += `<option value="${act.number}" ${scene.act === act.number ? 'selected' : ''}>Act ${act.number}${act.name ? ': ' + act.name : ''}</option>`;
      });
      
      // Prepare costume rows
      let costumeRows = '';
      if (scene.costumes && Object.keys(scene.costumes).length > 0) {
        Object.entries(scene.costumes).forEach(([role, costume]) => {
          costumeRows += `
            <div class="costume-row grid grid-cols-2 gap-4 mb-2">
              <div class="field">
                <input type="text" class="costume-role-edit" value="${role}" readonly>
              </div>
              <div class="field">
                <input type="text" class="costume-description-edit" value="${costume}">
              </div>
            </div>
          `;
        });
      }
      
      editModalContent.innerHTML = `
        <div class="p-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="field">
              <label for="edit-scene-act">Act</label>
              <select id="edit-scene-act">
                ${actOptions}
              </select>
            </div>
            
            <div class="field">
              <label for="edit-scene-name">Scene Name</label>
              <input type="text" id="edit-scene-name" value="${scene.name || ''}">
            </div>
          </div>
          
          <div class="grid grid-cols-1 gap-4 mt-2">
            <div class="field">
              <label for="edit-scene-song">Song/Musical Number (Optional)</label>
              <input type="text" id="edit-scene-song" value="${scene.song || ''}">
            </div>
          </div>
          
          <div class="field mt-2">
            <label for="edit-scene-costumes">Costume Requirements</label>
            <div id="edit-costume-assignments-container" class="border rounded p-4 bg-gray-50">
              <div class="flex justify-between items-center mb-4">
                <h4 class="m-0">Role Specific Costumes</h4>
              </div>
              
              <div id="edit-costume-rows">
                ${costumeRows}
              </div>
            </div>
          </div>
          
          <div class="field mt-4">
            <label>
              <input type="checkbox" id="edit-scene-special" ${scene.isSpecial ? 'checked' : ''}>
              This is a special scene with manual assignment
            </label>
            <p class="text-sm text-gray-500 mt-1">Special scenes allow manual assignment of performers regardless of the usual cover order.</p>
          </div>
        </div>
      `;
      
      editModal.style.display = 'flex';
      
      // Set up save action
      document.getElementById('save-edit').onclick = () => {
        // Update scene data
        scene.act = parseInt(document.getElementById('edit-scene-act').value);
        scene.name = document.getElementById('edit-scene-name').value;
        scene.song = document.getElementById('edit-scene-song').value;
        scene.isSpecial = document.getElementById('edit-scene-special').checked;
        
        // Update costumes
        const newCostumes = {};
        const costumeRoles = document.querySelectorAll('.costume-role-edit');
        const costumeDescriptions = document.querySelectorAll('.costume-description-edit');
        
        for (let i = 0; i < costumeRoles.length; i++) {
          const role = costumeRoles[i].value;
          const description = costumeDescriptions[i].value;
          
          if (role && description) {
            newCostumes[role] = description;
          }
        }
        
        scene.costumes = newCostumes;
        
        // Save to localStorage if auto-save is enabled
        if (app.settings.autoSave) {
          saveToLocalStorage();
        }
        
        // Update UI
        updateScenesList();
        
        // Close modal
        editModal.style.display = 'none';
        
        showToast("Scene updated successfully!");
      };
      
      // Set up cancel action
      document.getElementById('cancel-edit').onclick = 
      document.getElementById('close-edit-modal').onclick = () => {
        editModal.style.display = 'none';
      };
    }
    
    // Show confirmation dialog for deleting a scene
    function confirmDeleteScene(index) {
      const scene = app.scenes[index];
      
      // Find any special tracks that use this scene
      const associatedTracks = app.specialTracks.filter(track => parseInt(track.sceneIndex) === index);
      
      let message = `Are you sure you want to delete the scene "${scene.name}"?`;
      
      if (associatedTracks.length > 0) {
        message += `\n\nThis will also delete ${associatedTracks.length} special track(s) associated with this scene.`;
      }
      
      showConfirmationDialog(
        "Delete Scene",
        message,
        () => {
          // Remove scene
          app.scenes.splice(index, 1);
          
          // Remove associated special tracks
          app.specialTracks = app.specialTracks.filter(track => parseInt(track.sceneIndex) !== index);
          
          // Update sceneIndex for remaining special tracks
          app.specialTracks.forEach(track => {
            const trackSceneIndex = parseInt(track.sceneIndex);
            if (trackSceneIndex > index) {
              track.sceneIndex = (trackSceneIndex - 1).toString();
            }
          });
          
          // Save to localStorage if auto-save is enabled
          if (app.settings.autoSave) {
            saveToLocalStorage();
          }
          
          // Update UI
          updateScenesList();
          updateSpecialTracksList();
          
          showToast("Scene deleted successfully!");
        }
      );
    }
    
    // Show edit modal for a special track
    function editSpecialTrack(index) {
      const track = app.specialTracks[index];
      const editModal = elements.editModal;
      const editModalTitle = document.getElementById('edit-modal-title');
      const editModalContent = elements.editModalContent;
      
      editModalTitle.textContent = `Edit Special Track: ${track.name}`;
      
      // Prepare scene options
      let sceneOptions = '<option value="">Select a Scene</option>';
      app.scenes.forEach((scene, sceneIndex) => {
        const act = app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' };
        sceneOptions += `<option value="${sceneIndex}" ${track.sceneIndex == sceneIndex ? 'selected' : ''}>Act ${act.number} - ${scene.name}${scene.song ? ' (' + scene.song + ')' : ''}</option>`;
      });
      
      // Get all possible performers
      const allPerformers = [];
      
      // Add main cast
      app.mainCast.forEach(member => {
        allPerformers.push({
          name: member.actor,
          role: member.role,
          selected: track.eligiblePerformers && track.eligiblePerformers.includes(member.actor)
        });
      });
      
      // Add swings
      app.swings.forEach(swing => {
        allPerformers.push({
          name: swing.actor,
          role: swing.role,
          selected: track.eligiblePerformers && track.eligiblePerformers.includes(swing.actor)
        });
      });
      
      // Prepare eligible performers checkboxes
      let performersCheckboxes = '';
      if (allPerformers.length > 0) {
        allPerformers.forEach((performer, perfIndex) => {
          performersCheckboxes += `
            <div class="flex items-center">
              <input type="checkbox" id="edit-eligible-performer-${perfIndex}" class="edit-eligible-performer" data-name="${performer.name}" ${performer.selected ? 'checked' : ''}>
              <label for="edit-eligible-performer-${perfIndex}" class="ml-2">${performer.name}${performer.role ? ` (${performer.role})` : ''}</label>
            </div>
          `;
        });
      } else {
        performersCheckboxes = '<p class="text-gray-500 text-sm">No cast members defined yet.</p>';
      }
      
      editModalContent.innerHTML = `
        <div class="p-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="field">
              <label for="edit-track-name">Track Name</label>
              <input type="text" id="edit-track-name" value="${track.name || ''}">
            </div>
            
            <div class="field">
              <label for="edit-track-location">Scene Location</label>
              <select id="edit-track-location">
                ${sceneOptions}
              </select>
            </div>
          </div>
          
          <div class="field mt-2">
            <label for="edit-track-description">Description</label>
            <textarea id="edit-track-description" rows="2">${track.description || ''}</textarea>
          </div>
          
          <div class="field mt-2">
            <label>Eligible Performers</label>
            <div class="border rounded p-4 bg-gray-50">
              <p class="text-sm text-gray-500 mb-2">Select which cast members are eligible to perform this track:</p>
              <div class="grid grid-cols-3 gap-2">
                ${performersCheckboxes}
              </div>
            </div>
          </div>
          
          <div class="field mt-2">
            <label for="edit-track-count">Number of Performers Needed</label>
            <input type="number" id="edit-track-count" min="1" value="${track.performerCount || 1}">
            <p class="text-sm text-gray-500 mt-1">How many performers are needed for this track per performance?</p>
          </div>
        </div>
      `;
      
      editModal.style.display = 'flex';
      
      // Set up save action
      document.getElementById('save-edit').onclick = () => {
        // Update track data
        track.name = document.getElementById('edit-track-name').value;
        track.sceneIndex = document.getElementById('edit-track-location').value;
        track.description = document.getElementById('edit-track-description').value;
        track.performerCount = parseInt(document.getElementById('edit-track-count').value);
        
        // Update eligible performers
        const eligiblePerformers = [];
        document.querySelectorAll('.edit-eligible-performer').forEach(checkbox => {
          if (checkbox.checked) {
            eligiblePerformers.push(checkbox.dataset.name);
          }
        });
        
        track.eligiblePerformers = eligiblePerformers;
        
        // Save to localStorage if auto-save is enabled
        if (app.settings.autoSave) {
          saveToLocalStorage();
        }
        
        // Update UI
        updateSpecialTracksList();
        buildSpecialTracksUI();
        
        // Close modal
        editModal.style.display = 'none';
        
        showToast("Special track updated successfully!");
      };
      
      // Set up cancel action
      document.getElementById('cancel-edit').onclick = 
      document.getElementById('close-edit-modal').onclick = () => {
        editModal.style.display = 'none';
      };
    }
    
    // Show confirmation dialog for deleting a special track
    function confirmDeleteSpecialTrack(index) {
      const track = app.specialTracks[index];
      
      showConfirmationDialog(
        "Delete Special Track",
        `Are you sure you want to delete the special track "${track.name}"?`,
        () => {
          // Remove track
          app.specialTracks.splice(index, 1);
          
          // Remove any assignments for this track from current performance
          if (app.currentPerformance.specialAssignments && app.currentPerformance.specialAssignments[track.name]) {
            delete app.currentPerformance.specialAssignments[track.name];
          }
          
          // Save to localStorage if auto-save is enabled
          if (app.settings.autoSave) {
            saveToLocalStorage();
          }
          
          // Update UI
          updateSpecialTracksList();
          buildSpecialTracksUI();
          
          showToast("Special track deleted successfully!");
        }
      );
    }
    
    // Event Listeners
    // Production Setup Tab
    document.getElementById('save-production-info').addEventListener('click', () => {
      app.production.name = document.getElementById('production-name').value;
      app.production.subtitle = document.getElementById('production-subtitle').value;
      app.production.defaultVenue = document.getElementById('default-venue').value;
      app.production.defaultTime = document.getElementById('default-time').value;
      app.production.description = document.getElementById('production-description').value;
      
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      updateProductionInfo();
      showToast("Production information saved!");
    });
    
    document.getElementById('export-production-btn').addEventListener('click', exportProductionConfiguration);
    document.getElementById('import-production-file').addEventListener('change', importProductionConfiguration);
    document.getElementById('reset-production-btn').addEventListener('click', resetProductionConfiguration);
    
    // Cast Management Tab
    document.getElementById('add-role-btn').addEventListener('click', () => {
      const role = document.getElementById('new-role-name').value;
      const type = document.getElementById('new-role-type').value;
      const actor = document.getElementById('new-role-actor').value;
      const understudy1 = document.getElementById('new-role-understudy1').value;
      const understudy2 = document.getElementById('new-role-understudy2').value;
      const understudy3 = document.getElementById('new-role-understudy3').value;
      
      if (!role || !actor) {
        showToast("Role name and performer name are required", true);
        return;
      }
      
      // Add new cast member
      app.mainCast.push({
        role,
        type,
        actor,
        understudy1,
        understudy2,
        understudy3,
        isOff: false
      });
      
      // Clear form
      document.getElementById('new-role-name').value = '';
      document.getElementById('new-role-actor').value = '';
      document.getElementById('new-role-understudy1').value = '';
      document.getElementById('new-role-understudy2').value = '';
      document.getElementById('new-role-understudy3').value = '';
      
      // Save to localStorage if auto-save is enabled
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      // Update UI
      updateCastList();
      buildMainCastList();
      processCastAssignments();
      
      showToast("Role added successfully!");
    });
    
    document.getElementById('add-swing-btn').addEventListener('click', () => {
      const role = document.getElementById('new-swing-role').value;
      const actor = document.getElementById('new-swing-actor').value;
      const notes = document.getElementById('new-swing-notes').value;
      const coversRoles = document.getElementById('new-swing-roles').value;
      
      if (!role || !actor) {
        showToast("Swing role and performer name are required", true);
        return;
      }
      
      // Add new swing
      app.swings.push({
        role,
        actor,
        notes,
        coversRoles,
        isOff: false
      });
      
      // Clear form
      document.getElementById('new-swing-role').value = '';
      document.getElementById('new-swing-actor').value = '';
      document.getElementById('new-swing-notes').value = '';
      document.getElementById('new-swing-roles').value = '';
      
      // Save to localStorage if auto-save is enabled
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      // Update UI
      updateSwingsList();
      buildSwingsList();
      processCastAssignments();
      
      showToast("Swing added successfully!");
    });
    
    // Scene Management Tab
    document.getElementById('add-act-btn').addEventListener('click', () => {
      const number = parseInt(document.getElementById('new-act-number').value);
      const name = document.getElementById('new-act-name').value;
      
      if (!number) {
        showToast("Act number is required", true);
        return;
      }
      
      // Check for duplicate act number
      if (app.acts.some(act => act.number === number)) {
        showToast("An act with this number already exists", true);
        return;
      }
      
      // Add new act
      app.acts.push({
        number,
        name
      });
      
      // Clear form
      document.getElementById('new-act-name').value = '';
      
      // Save to localStorage if auto-save is enabled
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      // Update UI
      updateActsList();
      
      showToast("Act added successfully!");
    });
    
    document.getElementById('add-costume-row-btn').addEventListener('click', () => {
      const costumeRows = document.getElementById('costume-rows');
      
      const newRow = document.createElement('div');
      newRow.className = 'costume-row grid grid-cols-2 gap-4 mb-2';
      
      newRow.innerHTML = `
        <div class="field">
          <select class="costume-role">
            <option value="">Select a Role</option>
            <!-- Role options will be inserted by updateRoleSelectors() -->
          </select>
        </div>
        <div class="field">
          <input type="text" class="costume-description" placeholder="Costume description">
        </div>
      `;
      
      costumeRows.appendChild(newRow);
      
      // Update role selectors
      updateRoleSelectors();
    });
    
    document.getElementById('add-scene-btn').addEventListener('click', () => {
      const act = parseInt(document.getElementById('new-scene-act').value);
      const name = document.getElementById('new-scene-name').value;
      const song = document.getElementById('new-scene-song').value;
      const isSpecial = document.getElementById('new-scene-special').checked;
      
      if (!act || !name) {
        showToast("Act and scene name are required", true);
        return;
      }
      
      // Collect costume assignments
      const costumes = {};
      const costumeRows = document.querySelectorAll('.costume-row');
      
      costumeRows.forEach(row => {
        const roleSelect = row.querySelector('.costume-role');
        const descriptionInput = row.querySelector('.costume-description');
        
        const role = roleSelect.value;
        const description = descriptionInput.value;
        
        if (role && description) {
          costumes[role] = description;
        }
      });
      
      // Add new scene
      app.scenes.push({
        act,
        name,
        song,
        isSpecial,
        costumes
      });
      
      // Clear form
      document.getElementById('new-scene-name').value = '';
      document.getElementById('new-scene-song').value = '';
      document.getElementById('new-scene-special').checked = false;
      document.getElementById('costume-rows').innerHTML = `
        <div class="costume-row grid grid-cols-2 gap-4 mb-2">
          <div class="field">
            <select class="costume-role">
              <option value="">Select a Role</option>
              <!-- Role options will be inserted by updateRoleSelectors() -->
            </select>
          </div>
          <div class="field">
            <input type="text" class="costume-description" placeholder="Costume description">
          </div>
        </div>
      `;
      
      // Update role selectors
      updateRoleSelectors();
      
      // Save to localStorage if auto-save is enabled
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      // Update UI
      updateScenesList();
      
      showToast("Scene added successfully!");
    });
    
    // Special Tracks Tab
    document.getElementById('add-special-track-btn').addEventListener('click', () => {
      const name = document.getElementById('new-track-name').value;
      const sceneIndex = document.getElementById('new-track-location').value;
      const description = document.getElementById('new-track-description').value;
      const performerCount = document.getElementById('new-track-count').value;
      
      if (!name || !sceneIndex) {
        showToast("Track name and scene location are required", true);
        return;
      }
      
      // Collect eligible performers
      const eligiblePerformers = [];
      document.querySelectorAll('.eligible-performer:checked').forEach(checkbox => {
        eligiblePerformers.push(checkbox.dataset.name);
      });
      
      // Add new special track
      app.specialTracks.push({
        name,
        sceneIndex,
        description,
        performerCount,
        eligiblePerformers
      });
      
      // Clear form
      document.getElementById('new-track-name').value = '';
      document.getElementById('new-track-description').value = '';
      document.getElementById('new-track-count').value = '1';
      
      // Uncheck all performers
      document.querySelectorAll('.eligible-performer').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Save to localStorage if auto-save is enabled
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      // Update UI
      updateSpecialTracksList();
      buildSpecialTracksUI();
      
      showToast("Special track added successfully!");
    });
    
    // Settings Tab
    document.getElementById('save-rules-btn').addEventListener('click', () => {
      app.settings.rules = document.getElementById('production-rules').value;
      
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      updateProductionRulesDisplay();
      
      showToast("Production rules saved!");
    });
    
    document.getElementById('save-settings-btn').addEventListener('click', () => {
      app.settings.autoSave = document.getElementById('auto-save').checked;
      app.settings.theme = document.getElementById('theme-selector').value;
      
      // Save email settings
      app.settings.emailSettings = {
        defaultRecipients: document.getElementById('default-recipients').value.split(',').map(email => email.trim()).filter(email => email),
        ccRecipients: document.getElementById('cc-recipients').value.split(',').map(email => email.trim()).filter(email => email),
        emailTemplate: document.getElementById('email-template').value
      };
      
      // Save calendar integration settings
      app.calendarIntegration = {
        enabled: document.getElementById('enable-calendar-integration').checked,
        syncDirection: document.getElementById('calendar-sync-direction').value
      };
      
      // Save to localStorage
      saveToLocalStorage();
      
      // Apply theme
      applyTheme(app.settings.theme);
      
      showToast("Settings saved!");
    });
    
    // Email PDF functionality
    document.getElementById('email-pdf').addEventListener('click', () => {
      // Populate email form with default values from settings
      if (app.settings.emailSettings) {
        document.getElementById('email-to').value = app.settings.emailSettings.defaultRecipients.join(', ');
        document.getElementById('email-cc').value = app.settings.emailSettings.ccRecipients.join(', ');
        
        // Create subject and body from template
        const showDate = document.getElementById('show-date').value;
        const formattedDate = formatDate(showDate);
        const performanceTime = document.getElementById('performance-time').value;
        const venue = document.getElementById('venue').value;
        
        let subject = `${app.production.name || 'Production'} Off Sheet - ${formattedDate}`;
        document.getElementById('email-subject').value = subject;
        
        let body = app.settings.emailSettings.emailTemplate || '';
        body = body.replace('[PRODUCTION_NAME]', app.production.name || 'Production')
                  .replace('[PERFORMANCE_DATE]', formattedDate)
                  .replace('[PERFORMANCE_TIME]', performanceTime)
                  .replace('[VENUE]', venue);
        
        document.getElementById('email-body').value = body;
      }
      
      // Show email modal
      document.getElementById('email-modal').style.display = 'flex';
    });
    
    // Send email function
    document.getElementById('send-email').addEventListener('click', () => {
      const to = document.getElementById('email-to').value;
      const cc = document.getElementById('email-cc').value;
      const subject = document.getElementById('email-subject').value;
      const body = document.getElementById('email-body').value;
      
      if (!to) {
        showToast("Please enter at least one recipient email", true);
        return;
      }
      
      // Save email settings if checkbox is checked
      if (document.getElementById('save-email-settings').checked) {
        app.settings.emailSettings.defaultRecipients = to.split(',').map(email => email.trim()).filter(email => email);
        app.settings.emailSettings.ccRecipients = cc.split(',').map(email => email.trim()).filter(email => email);
        
        if (app.settings.autoSave) {
          saveToLocalStorage();
        }
      }
      
      // Create a mailto: URL
      const mailtoLink = `mailto:${to}?${cc ? 'cc=' + cc + '&' : ''}subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      
      // Open email client
      window.location.href = mailtoLink;
      
      // Close modal
      document.getElementById('email-modal').style.display = 'none';
      
      showToast("Email client opened!");
    });
    
    // Close email modal
    document.getElementById('close-email-modal').addEventListener('click', () => {
      document.getElementById('email-modal').style.display = 'none';
    });
    
    document.getElementById('cancel-email').addEventListener('click', () => {
      document.getElementById('email-modal').style.display = 'none';
    });
    
    // Share PDF functionality
    document.getElementById('share-pdf').addEventListener('click', () => {
      // Generate a "fake" share link for demo purposes
      const showDate = document.getElementById('show-date').value;
      const shareId = Math.random().toString(36).substring(2, 15);
      const shareLink = `https://offsheet.example.com/share/${shareId}`;
      
      document.getElementById('share-link').value = shareLink;
      
      // Show share modal
      document.getElementById('share-modal').style.display = 'flex';
      
      // Create a simple ASCII QR code representation (for demo purposes)
      document.getElementById('share-qrcode').innerHTML = `
        <div style="font-family: monospace; line-height: 1; font-size: 8px; letter-spacing: -0.1em; white-space: pre;">
          █████████████████████████<br>
          █████████████████████████<br>
          ████ ▄▄▄▄▄ █▀▄█ ▄▄▄▄▄ ████<br>
          ████ █   █ █▀▄█ █   █ ████<br>
          ████ █▄▄▄█ █ ▀█ █▄▄▄█ ████<br>
          ████▄▄▄▄▄▄▄█▄█▄█▄▄▄▄▄▄████<br>
          ████   ▀ ▄▄▀▀ ▄▀▄▀▀ ▀ ████<br>
          ████▄█▀▄▄▄ ▀█▄ █▀█ █▄▀████<br>
          ████▄ ▄▄▀▀▀▄▀▀▄ ▀▄▄█▀█████<br>
          ████ ▄█▄▀▄█▄█▀ ▄ ▀  ▀ ████<br>
          ████▄███▄█▄▄ ▄▄▄ ▄█▄▀▀████<br>
          ████ ▄▄▄▄▄ █▄▀  █▄█ ▀▄████<br>
          ████ █   █ █ ▄▄▄█▄▄▀▀▀████<br>
          ████ █▄▄▄█ █ ▀▄▀▄▄▄▄▀█████<br>
          █████████████████████████<br>
          ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀<br>
          Scan to view the Off Sheet
        </div>
      `;
    });
    
    // Copy share link
    document.getElementById('copy-link').addEventListener('click', () => {
      const shareLink = document.getElementById('share-link');
      shareLink.select();
      document.execCommand('copy');
      
      showToast("Link copied to clipboard!");
    });
    
    // Close share modal
    document.getElementById('close-share-modal').addEventListener('click', () => {
      document.getElementById('share-modal').style.display = 'none';
    });
    
    document.getElementById('close-share').addEventListener('click', () => {
      document.getElementById('share-modal').style.display = 'none';
    });
    
    // Share via different platforms
    document.getElementById('share-slack').addEventListener('click', () => {
      const shareLink = document.getElementById('share-link').value;
      window.open(`https://slack.com/app_redirect?channel=general&message=${encodeURIComponent(`Off Sheet for ${app.production.name}: ${shareLink}`)}`);
    });
    
    document.getElementById('share-teams').addEventListener('click', () => {
      const shareLink = document.getElementById('share-link').value;
      window.open(`https://teams.microsoft.com/share?href=${encodeURIComponent(shareLink)}&referrer=${encodeURIComponent(window.location.href)}`);
    });
    
    document.getElementById('share-whatsapp').addEventListener('click', () => {
      const shareLink = document.getElementById('share-link').value;
      window.open(`https://wa.me/?text=${encodeURIComponent(`Off Sheet for ${app.production.name}: ${shareLink}`)}`);
    });
    
    // Add Prop functionality
    document.getElementById('add-prop-btn').addEventListener('click', () => {
      const name = document.getElementById('new-prop-name').value;
      const category = document.getElementById('new-prop-category').value;
      const description = document.getElementById('new-prop-description').value;
      const responsible = document.getElementById('new-prop-responsible').value;
      
      if (!name) {
        showToast("Prop name is required", true);
        return;
      }
      
      // Collect scenes where this prop appears
      const sceneIds = [];
      document.querySelectorAll('#prop-scenes-list input:checked').forEach(checkbox => {
        sceneIds.push(parseInt(checkbox.value));
      });
      
      // Add new prop
      app.props.push({
        name,
        category,
        description,
        responsible,
        sceneIds
      });
      
      // Clear form
      document.getElementById('new-prop-name').value = '';
      document.getElementById('new-prop-description').value = '';
      document.getElementById('new-prop-responsible').value = '';
      
      // Uncheck all scenes
      document.querySelectorAll('#prop-scenes-list input').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Save to localStorage if auto-save is enabled
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
      
      // Update UI
      updatePropsList();
      
      showToast("Prop added successfully!");
    });
    
    // Calendar export functionality
    document.getElementById('export-to-calendar-btn').addEventListener('click', () => {
      generateICalFile();
    });
    
    document.getElementById('export-google-calendar-btn').addEventListener('click', () => {
      const showDate = document.getElementById('show-date').value;
      const performanceTime = document.getElementById('performance-time').value;
      const venue = document.getElementById('venue').value;
      
      // Create Google Calendar event URL
      const dateObj = new Date(showDate + 'T' + performanceTime);
      const endDateObj = new Date(dateObj.getTime() + (3 * 60 * 60 * 1000)); // Add 3 hours for performance duration
      
      const startDate = dateObj.toISOString().replace(/-|:|\.\d+/g, '');
      const endDate = endDateObj.toISOString().replace(/-|:|\.\d+/g, '');
      
      const eventTitle = encodeURIComponent(`${app.production.name || 'Performance'}`);
      const eventDetails = encodeURIComponent(`Off Sheet details:\n${offSummary}`);
      const eventLocation = encodeURIComponent(venue);
      
      const googleCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${eventTitle}&dates=${startDate}/${endDate}&details=${eventDetails}&location=${eventLocation}`;
      
      window.open(googleCalUrl, '_blank');
    });
    
    // Function to generate iCal file for calendar export
    function generateICalFile() {
      const showDate = document.getElementById('show-date').value;
      const performanceTime = document.getElementById('performance-time').value;
      const venue = document.getElementById('venue').value;
      
      // Create start and end dates (assume 3 hour performance)
      const dateObj = new Date(showDate + 'T' + performanceTime);
      const endDateObj = new Date(dateObj.getTime() + (3 * 60 * 60 * 1000));
      
      // Format dates for iCal
      const formatICalDate = (date) => {
        return date.toISOString().replace(/-|:|\.\d+/g, '');
      };
      
      const startDate = formatICalDate(dateObj);
      const endDate = formatICalDate(endDateObj);
      const now = formatICalDate(new Date());
      
      // Create unique ID
      const uid = `${startDate}-${Math.random().toString(36).substring(2, 11)}@offsheet`;
      
      // Create iCal content
      let iCalContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Production Off Sheet Manager//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `DTSTAMP:${now}`,
        `DTSTART:${startDate}`,
        `DTEND:${endDate}`,
        `SUMMARY:${app.production.name || 'Performance'}`,
        `DESCRIPTION:${offSummary.replace(/\n/g, '\\n')}`,
        `LOCATION:${venue}`,
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
      
      // Create and download the file
      const blob = new Blob([iCalContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${app.production.name || 'performance'}_${showDate}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast("Calendar file downloaded!");
    }
    
    // Function to update props list
    function updatePropsList() {
      const propsListContainer = document.getElementById('props-list-container');
      
      if (!propsListContainer) return;
      
      if (app.props.length === 0) {
        propsListContainer.innerHTML = '<p class="text-gray-500 text-sm">No props defined yet. Add props using the form above.</p>';
        return;
      }
      
      let html = '';
      
      app.props.forEach((prop, index) => {
        // Find scenes this prop appears in
        const sceneNames = prop.sceneIds.map(sceneId => {
          const scene = app.scenes[sceneId];
          if (scene) {
            const act = app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' };
            return `Act ${act.number} - ${scene.name}`;
          }
          return 'Unknown Scene';
        }).join(', ');
        
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="font-medium">${prop.name}</div>
              <div class="text-sm">Category: ${prop.category}</div>
              ${prop.description ? `<div class="text-sm">${prop.description}</div>` : ''}
              ${prop.responsible ? `<div class="text-sm">Responsible: ${prop.responsible}</div>` : ''}
              ${sceneNames ? `<div class="text-sm text-gray-500">Appears in: ${sceneNames}</div>` : ''}
            </div>
            <div class="list-item-actions">
              <button class="button" data-action="edit-prop" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
              </button>
              <button class="button red" data-action="delete-prop" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </div>
        `;
      });
      
      propsListContainer.innerHTML = html;
      
      // Add event listeners for edit and delete buttons
      const editButtons = propsListContainer.querySelectorAll('[data-action="edit-prop"]');
      const deleteButtons = propsListContainer.querySelectorAll('[data-action="delete-prop"]');
      
      editButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          editProp(index);
        });
      });
      
      deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          confirmDeleteProp(index);
        });
      });
    }
    
    // Function to setup prop scenes list
    function setupPropScenesList() {
      const propScenesList = document.getElementById('prop-scenes-list');
      
      if (!propScenesList) return;
      
      if (app.scenes.length === 0) {
        propScenesList.innerHTML = '<p class="text-gray-500 text-sm">No scenes defined yet. Go to Scene Management to add scenes.</p>';
        return;
      }
      
      let html = '';
      
      // Group scenes by act
      const scenesByAct = {};
      
      app.scenes.forEach((scene, index) => {
        const actNum = scene.act;
        if (!scenesByAct[actNum]) {
          scenesByAct[actNum] = [];
        }
        scenesByAct[actNum].push({ scene, index });
      });
      
      // Sort acts numerically
      const sortedActs = Object.keys(scenesByAct).sort((a, b) => parseInt(a) - parseInt(b));
      
      // For each act, add its scenes
      sortedActs.forEach(actNum => {
        const act = app.acts.find(a => a.number === parseInt(actNum)) || { number: actNum, name: '' };
        
        html += `<div class="font-medium mb-2">Act ${act.number}${act.name ? ': ' + act.name : ''}</div>`;
        
        scenesByAct[actNum].forEach(({ scene, index }) => {
          html += `
            <div class="flex items-center mb-1">
              <input type="checkbox" id="prop-scene-${index}" value="${index}" class="mr-2">
              <label for="prop-scene-${index}">${scene.name}${scene.song ? ` (${scene.song})` : ''}</label>
            </div>
          `;
        });
        
        html += '<div class="mb-3"></div>';
      });
      
      propScenesList.innerHTML = html;
    }
    
    // Function to update the scene tracking view
    function updateSceneTracking(sceneIndex) {
      const container = document.getElementById('scene-tracking-container');
      
      if (!container) return;
      
      if (sceneIndex === '' || !app.scenes[sceneIndex]) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Select a scene to view tracking details.</p>';
        return;
      }
      
      const scene = app.scenes[sceneIndex];
      const act = app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' };
      
      // Get props in this scene
      const sceneProps = app.props.filter(prop => prop.sceneIds.includes(parseInt(sceneIndex)));
      
      let html = `
        <h3 class="font-medium mb-3">Act ${act.number} - ${scene.name}${scene.song ? ` (${scene.song})` : ''}</h3>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="border rounded p-4">
            <h4 class="font-medium mb-2">Costumes in this Scene</h4>
            <div class="max-h-60 overflow-y-auto">
              <table class="w-full">
                <thead>
                  <tr>
                    <th class="text-left p-2">Role</th>
                    <th class="text-left p-2">Costume</th>
                  </tr>
                </thead>
                <tbody>
      `;
      
      // Add costume rows
      if (scene.costumes && Object.keys(scene.costumes).length > 0) {
        Object.entries(scene.costumes).forEach(([role, costume]) => {
          html += `
            <tr>
              <td class="p-2">${role}</td>
              <td class="p-2">${costume}</td>
            </tr>
          `;
        });
      } else {
        html += `
          <tr>
            <td colspan="2" class="p-2 text-gray-500 text-sm">No costumes defined for this scene.</td>
          </tr>
        `;
      }
      
      html += `
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="border rounded p-4">
            <h4 class="font-medium mb-2">Props in this Scene</h4>
            <div class="max-h-60 overflow-y-auto">
              <table class="w-full">
                <thead>
                  <tr>
                    <th class="text-left p-2">Prop</th>
                    <th class="text-left p-2">Category</th>
                    <th class="text-left p-2">Responsible</th>
                  </tr>
                </thead>
                <tbody>
      `;
      
      // Add prop rows
      if (sceneProps.length > 0) {
        sceneProps.forEach(prop => {
          html += `
            <tr>
              <td class="p-2">${prop.name}</td>
              <td class="p-2">${prop.category}</td>
              <td class="p-2">${prop.responsible || '-'}</td>
            </tr>
          `;
        });
      } else {
        html += `
          <tr>
            <td colspan="3" class="p-2 text-gray-500 text-sm">No props defined for this scene.</td>
          </tr>
        `;
      }
      
      html += `
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <button id="print-tracking-btn" class="button purple">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
          Print Tracking Sheet
        </button>
      `;
      
      container.innerHTML = html;
      
      // Add print tracking event listener
      document.getElementById('print-tracking-btn').addEventListener('click', () => {
        printTrackingSheet(sceneIndex);
      });
    }
    
    // Function to print tracking sheet
    function printTrackingSheet(sceneIndex) {
      const scene = app.scenes[sceneIndex];
      const act = app.acts.find(a => a.number === scene.act) || { number: scene.act, name: '' };
      
      // Get props in this scene
      const sceneProps = app.props.filter(prop => prop.sceneIds.includes(parseInt(sceneIndex)));
      
      const printArea = document.getElementById('print-area');
      
      // Build the HTML for the printable tracking sheet
      let printHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
          <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
            <h1 style="margin: 0 0 5px 0; font-size: 24px;">${app.production.name || 'Production'} - Tracking Sheet</h1>
            <p>Act ${act.number} - ${scene.name}${scene.song ? ` (${scene.song})` : ''}</p>
          </div>
          
          <h2 style="margin-top: 20px;">Costume Tracking</h2>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Role</th>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Performer</th>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Costume</th>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Notes</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      // Add costume rows
      if (scene.costumes && Object.keys(scene.costumes).length > 0) {
        Object.entries(scene.costumes).forEach(([role, costume]) => {
          // Find performer for this role based on latest assignments
          let performer = '';
          if (dailyCast) {
            const castMember = dailyCast.find(member => member.role === role);
            if (castMember) {
              performer = castMember.coveringActor || castMember.actor;
            }
          }
          
          printHTML += `
            <tr>
              <td style="border: 1px solid #ccc; padding: 8px;">${role}</td>
              <td style="border: 1px solid #ccc; padding: 8px;">${performer}</td>
              <td style="border: 1px solid #ccc; padding: 8px;">${costume}</td>
              <td style="border: 1px solid #ccc; padding: 8px;"></td>
            </tr>
          `;
        });
      } else {
        printHTML += `
          <tr>
            <td colspan="4" style="border: 1px solid #ccc; padding: 8px; color: #666;">No costumes defined for this scene.</td>
          </tr>
        `;
      }
      
      printHTML += `
            </tbody>
          </table>
          
          <h2 style="margin-top: 20px;">Props Tracking</h2>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Prop</th>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Category</th>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Responsible</th>
                <th style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; text-align: left;">Status</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      // Add prop rows
      if (sceneProps.length > 0) {
        sceneProps.forEach(prop => {
          printHTML += `
            <tr>
              <td style="border: 1px solid #ccc; padding: 8px;">${prop.name}</td>
              <td style="border: 1px solid #ccc; padding: 8px;">${prop.category}</td>
              <td style="border: 1px solid #ccc; padding: 8px;">${prop.responsible || '-'}</td>
              <td style="border: 1px solid #ccc; padding: 8px;"></td>
            </tr>
          `;
        });
      } else {
        printHTML += `
          <tr>
            <td colspan="4" style="border: 1px solid #ccc; padding: 8px; color: #666;">No props defined for this scene.</td>
          </tr>
        `;
      }
      
      printHTML += `
            </tbody>
          </table>
          
          <div style="margin-top: 20px; padding: 15px; border: 1px solid #ccc;">
            <h3 style="margin-top: 0;">Additional Notes:</h3>
            <div style="min-height: 100px;"></div>
          </div>
        </div>
      `;
      
      printArea.innerHTML = printHTML;
      
      window.print();
    }
    
    // Function to update settings UI
    function updateSettingsUI() {
      document.getElementById('auto-save').checked = app.settings.autoSave;
      document.getElementById('theme-selector').value = app.settings.theme;
      document.getElementById('production-rules').value = app.settings.rules || '';
      
      // Update email settings
      if (app.settings.emailSettings) {
        document.getElementById('default-recipients').value = app.settings.emailSettings.defaultRecipients.join(', ');
        document.getElementById('cc-recipients').value = app.settings.emailSettings.ccRecipients.join(', ');
        document.getElementById('email-template').value = app.settings.emailSettings.emailTemplate || '';
      }
      
      // Update calendar integration settings
      document.getElementById('enable-calendar-integration').checked = app.calendarIntegration?.enabled || false;
      document.getElementById('calendar-sync-direction').value = app.calendarIntegration?.syncDirection || 'export-only';
      
      // Update production rules display
      updateProductionRulesDisplay();
      
      // Apply theme if it exists
      applyTheme(app.settings.theme);
    }
    
    // Function to update performance history UI
    function updatePerformanceHistory() {
      const performancesList = document.getElementById('performances-list-container');
      const statsTotal = document.getElementById('stat-total-performances');
      const statsMissed = document.getElementById('stat-most-missed');
      const statsCovered = document.getElementById('stat-most-covered');
      
      if (!performancesList || !statsTotal || !statsMissed || !statsCovered) return;
      
      if (app.performanceHistory.length === 0) {
        performancesList.innerHTML = '<p class="text-gray-500 text-sm">No saved performances yet. Daily operations data will appear here when saved.</p>';
        statsTotal.textContent = '0';
        statsMissed.textContent = '-';
        statsCovered.textContent = '-';
        return;
      }
      
      // Update statistics
      statsTotal.textContent = app.performanceHistory.length;
      
      // Calculate most frequently absent performer
      const absenceCount = {};
      app.performanceHistory.forEach(perf => {
        if (perf.offPerformers) {
          perf.offPerformers.forEach(off => {
            absenceCount[off.actor] = (absenceCount[off.actor] || 0) + 1;
          });
        }
      });
      
      let mostAbsent = { name: '-', count: 0 };
      Object.entries(absenceCount).forEach(([name, count]) => {
        if (count > mostAbsent.count) {
          mostAbsent = { name, count };
        }
      });
      
      statsMissed.textContent = mostAbsent.name !== '-' ? 
        `${mostAbsent.name} (${mostAbsent.count})` : '-';
      
      // Calculate most covered role
      const coverageCount = {};
      app.performanceHistory.forEach(perf => {
        if (perf.castAssignments) {
          Object.entries(perf.castAssignments).forEach(([role, assignment]) => {
            if (assignment.isOff || assignment.needsCover) {
              coverageCount[role] = (coverageCount[role] || 0) + 1;
            }
          });
        }
      });
      
      let mostCovered = { role: '-', count: 0 };
      Object.entries(coverageCount).forEach(([role, count]) => {
        if (count > mostCovered.count) {
          mostCovered = { role, count };
        }
      });
      
      statsCovered.textContent = mostCovered.role !== '-' ? 
        `${mostCovered.role} (${mostCovered.count})` : '-';
      
      // Build performances list
      let html = '<div class="space-y-4">';
      
      app.performanceHistory.sort((a, b) => new Date(b.date) - new Date(a.date))
                         .forEach((perf, index) => {
        const formattedDate = formatDate(perf.date);
        
        html += `
          <div class="border rounded p-4">
            <div class="flex justify-between items-center mb-2">
              <h4 class="font-medium">${formattedDate} - ${perf.time}</h4>
              <div>
                <button class="button" data-action="view-performance" data-index="${index}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
                <button class="button red" data-action="delete-performance" data-index="${index}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
              </div>
            </div>
            <div class="text-sm">Venue: ${perf.venue || '-'}</div>
            <div class="text-sm mt-2">Off Performers: ${perf.offPerformers?.length || 0}</div>
            ${perf.notes ? `<div class="text-sm text-gray-500 mt-2">${perf.notes}</div>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      
      performancesList.innerHTML = html;
      
      // Add event listeners for view and delete buttons
      const viewButtons = performancesList.querySelectorAll('[data-action="view-performance"]');
      const deleteButtons = performancesList.querySelectorAll('[data-action="delete-performance"]');
      
      viewButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          viewPerformance(index);
        });
      });
      
      deleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const index = parseInt(button.dataset.index);
          confirmDeletePerformance(index);
        });
      });
    }
    
    // Function to update track scene dropdown
    function updateTrackSceneDropdown() {
      const trackSceneSelect = document.getElementById('track-scene-select');
      
      if (!trackSceneSelect) return;
      
      // Clear current options
      trackSceneSelect.innerHTML = '<option value="">Select a Scene</option>';
      
      if (app.scenes.length === 0) {
        return;
      }
      
      // Group scenes by act
      const scenesByAct = {};
      
      app.scenes.forEach((scene, index) => {
        const actNum = scene.act;
        if (!scenesByAct[actNum]) {
          scenesByAct[actNum] = [];
        }
        scenesByAct[actNum].push({ scene, index });
      });
      
      // Sort acts numerically
      const sortedActs = Object.keys(scenesByAct).sort((a, b) => parseInt(a) - parseInt(b));
      
      // For each act, add options for its scenes
      sortedActs.forEach(actNum => {
        const act = app.acts.find(a => a.number === parseInt(actNum)) || { number: actNum, name: '' };
        
        const optgroup = document.createElement('optgroup');
        optgroup.label = `Act ${act.number}${act.name ? ': ' + act.name : ''}`;
        
        scenesByAct[actNum].forEach(({ scene, index }) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = `${scene.name}${scene.song ? ` (${scene.song})` : ''}`;
          optgroup.appendChild(option);
        });
        
        trackSceneSelect.appendChild(optgroup);
      });
      
      // Add event listener for scene selection
      trackSceneSelect.addEventListener('change', () => {
        updateSceneTracking(trackSceneSelect.value);
      });
    }
    
    // Save current performance to history
    function savePerformanceToHistory() {
      // Create a copy of current performance data
      const performanceData = {
        date: document.getElementById('show-date').value,
        time: document.getElementById('performance-time').value,
        venue: document.getElementById('venue').value,
        notes: document.getElementById('performance-notes').value,
        offPerformers: [],
        specialAssignments: { ...app.currentPerformance.specialAssignments },
        castAssignments: JSON.parse(JSON.stringify(dailyCast))
      };
      
      // Collect off performers from the UI
      app.mainCast.forEach(member => {
        if (member.isOff) {
          performanceData.offPerformers.push({
            type: 'main',
            actor: member.actor,
            role: member.role
          });
        }
      });
      
      app.swings.forEach(swing => {
        if (swing.isOff) {
          performanceData.offPerformers.push({
            type: 'swing',
            actor: swing.actor,
            role: swing.role
          });
        }
      });
      
      // Add to history
      app.performanceHistory.push(performanceData);
      
      // Save to localStorage
      saveToLocalStorage();
      
      showToast("Performance saved to history!");
    }
    
    // Daily Operations Tab
    document.getElementById('save-btn').addEventListener('click', saveConfiguration);
    document.getElementById('load-file').addEventListener('change', loadConfiguration);
    document.getElementById('print-btn').addEventListener('click', generatePrintableOffSheet);
    document.getElementById('generate-pdf-btn').addEventListener('click', generatePDF);
    document.getElementById('close-modal').addEventListener('click', closePDFModal);
    document.getElementById('download-pdf').addEventListener('click', downloadPDF);
    document.getElementById('print-pdf').addEventListener('click', printPDF);
    
    // Note changes in daily operations
    document.getElementById('performance-notes').addEventListener('input', function() {
      if (app.settings.autoSave) {
        app.currentPerformance.notes = this.value;
        saveToLocalStorage();
      }
    });
    
    // Date and time changes in daily operations
    document.getElementById('show-date').addEventListener('change', function() {
      app.currentPerformance.date = this.value;
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
    });
    
    document.getElementById('performance-time').addEventListener('change', function() {
      app.currentPerformance.time = this.value;
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
    });
    
    document.getElementById('venue').addEventListener('change', function() {
      app.currentPerformance.venue = this.value;
      if (app.settings.autoSave) {
        saveToLocalStorage();
      }
    });
    
    // Initialize the app
    function init() {
      // Load data from localStorage
      loadFromLocalStorage();
      
      // Set today's date if not already set
      if (!document.getElementById('show-date').value) {
        document.getElementById('show-date').value = new Date().toISOString().split('T')[0];
        app.currentPerformance.date = document.getElementById('show-date').value;
      }
      
      // Initialize UI components
      updateCastList();
      updateSwingsList();
      updateActsList();
      updateScenesList();
      updateSpecialTracksList();
      updateSettingsUI();
      
      // Build the daily operations UI
      buildMainCastList();
      buildSwingsList();
      buildSpecialTracksUI();
      processCastAssignments();
      
      // Update role selectors for costume assignments
      updateRoleSelectors();
      
      // Set up prop tracking UI
      setupPropScenesList();
      updatePropsList();
      updateTrackSceneDropdown();
      
      // Update performance history
      updatePerformanceHistory();
    }
    
    // Event listeners for new tabs
    
    // Props & Tracking tab listeners
    document.getElementById('track-scene-select')?.addEventListener('change', function() {
      updateSceneTracking(this.value);
    });
    
    // Performance History tab listeners
    document.getElementById('view-calendar-btn')?.addEventListener('click', function() {
      const month = document.getElementById('performance-month').value;
      displayPerformanceCalendar(month);
    });
    
    document.getElementById('performance-search')?.addEventListener('input', function() {
      filterPerformancesList(this.value);
    });
    
    // Add "Save Performance" button to Daily Operations
    const dailyOperationsControls = document.querySelector('#daily-operations .controls .flex');
    if (dailyOperationsControls) {
      const saveHistoryBtn = document.createElement('button');
      saveHistoryBtn.id = 'save-history-btn';
      saveHistoryBtn.className = 'button orange';
      saveHistoryBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        Save to History
      `;
      dailyOperationsControls.appendChild(saveHistoryBtn);
      
      saveHistoryBtn.addEventListener('click', savePerformanceToHistory);
    }
    
    // Display performance calendar
    function displayPerformanceCalendar(monthStr) {
      const calendarContainer = document.getElementById('performance-calendar-container');
      
      if (!calendarContainer) return;
      
      if (!monthStr) {
        calendarContainer.innerHTML = '<p class="text-gray-500 text-sm">Select a month to view performances.</p>';
        return;
      }
      
      const [year, month] = monthStr.split('-').map(num => parseInt(num));
      const monthDate = new Date(year, month - 1, 1);
      
      // Get performances in this month
      const monthPerformances = app.performanceHistory.filter(perf => {
        const perfDate = new Date(perf.date);
        return perfDate.getMonth() === month - 1 && perfDate.getFullYear() === year;
      });
      
      // Build calendar HTML
      let html = `
        <h3 class="mb-3">${monthDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
        <table class="w-full border-collapse">
          <thead>
            <tr>
              <th class="p-2 text-center">Sun</th>
              <th class="p-2 text-center">Mon</th>
              <th class="p-2 text-center">Tue</th>
              <th class="p-2 text-center">Wed</th>
              <th class="p-2 text-center">Thu</th>
              <th class="p-2 text-center">Fri</th>
              <th class="p-2 text-center">Sat</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month - 1, 1).getDay();
      const daysInMonth = new Date(year, month, 0).getDate();
      
      // Create calendar grid
      let dayCount = 1;
      let weekHTML = '<tr>';
      
      // Fill in empty cells for first week
      for (let i = 0; i < firstDay; i++) {
        weekHTML += '<td class="p-2 border text-center text-gray-300"></td>';
      }
      
      // Fill in days
      for (let i = firstDay; i < 7; i++) {
        const date = `${year}-${month.toString().padStart(2, '0')}-${dayCount.toString().padStart(2, '0')}`;
        const performances = monthPerformances.filter(perf => perf.date === date);
        
        weekHTML += `
          <td class="p-2 border ${performances.length > 0 ? 'bg-blue-50' : ''}">
            <div class="text-center">${dayCount}</div>
            ${performances.length > 0 ? `
              <div class="mt-1">
                ${performances.map(perf => `
                  <div class="text-xs bg-blue-100 p-1 rounded mb-1">
                    ${perf.time} - ${app.production.name || 'Performance'}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </td>
        `;
        
        dayCount++;
      }
      
      weekHTML += '</tr>';
      html += weekHTML;
      
      // Fill in remaining weeks
      while (dayCount <= daysInMonth) {
        weekHTML = '<tr>';
        
        for (let i = 0; i < 7; i++) {
          if (dayCount <= daysInMonth) {
            const date = `${year}-${month.toString().padStart(2, '0')}-${dayCount.toString().padStart(2, '0')}`;
            const performances = monthPerformances.filter(perf => perf.date === date);
            
            weekHTML += `
              <td class="p-2 border ${performances.length > 0 ? 'bg-blue-50' : ''}">
                <div class="text-center">${dayCount}</div>
                ${performances.length > 0 ? `
                  <div class="mt-1">
                    ${performances.map(perf => `
                      <div class="text-xs bg-blue-100 p-1 rounded mb-1">
                        ${perf.time} - ${app.production.name || 'Performance'}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </td>
            `;
          } else {
            weekHTML += '<td class="p-2 border text-center text-gray-300"></td>';
          }
          
          dayCount++;
        }
        
        weekHTML += '</tr>';
        html += weekHTML;
      }
      
      html += `
          </tbody>
        </table>
      `;
      
      calendarContainer.innerHTML = html;
    }
    
    // Filter performances list by search term
    function filterPerformancesList(searchTerm) {
      const performancesList = document.getElementById('performances-list-container');
      
      if (!performancesList) return;
      
      if (app.performanceHistory.length === 0) {
        return;
      }
      
      const searchLower = searchTerm.toLowerCase().trim();
      
      // Get all performance rows
      const performanceRows = performancesList.querySelectorAll('.border.rounded.p-4');
      
      performanceRows.forEach(row => {
        const date = row.querySelector('h4')?.textContent.toLowerCase() || '';
        const venue = row.querySelector('.text-sm')?.textContent.toLowerCase() || '';
        const notes = row.querySelector('.text-sm.text-gray-500')?.textContent.toLowerCase() || '';
        
        if (date.includes(searchLower) || venue.includes(searchLower) || notes.includes(searchLower)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    // View performance details
    function viewPerformance(index) {
      const performance = app.performanceHistory[index];
      
      if (!performance) return;
      
      // Set daily operations to match this historical performance
      document.getElementById('show-date').value = performance.date;
      document.getElementById('performance-time').value = performance.time;
      document.getElementById('venue').value = performance.venue || '';
      document.getElementById('performance-notes').value = performance.notes || '';
      
      // Set off performers
      app.mainCast.forEach(member => {
        member.isOff = performance.offPerformers?.some(off => 
          off.type === 'main' && off.actor === member.actor) || false;
      });
      
      app.swings.forEach(swing => {
        swing.isOff = performance.offPerformers?.some(off => 
          off.type === 'swing' && off.actor === swing.actor) || false;
      });
      
      // Set special assignments
      app.currentPerformance.specialAssignments = { ...performance.specialAssignments };
      
      // Rebuild UI
      buildMainCastList();
      buildSwingsList();
      buildSpecialTracksUI();
      processCastAssignments();
      
      // Change to daily operations tab
      const dailyTab = document.querySelector('[data-tab="daily-operations"]');
      if (dailyTab) dailyTab.click();
      
      showToast("Historical performance loaded!");
    }
    
    // Confirm delete performance
    function confirmDeletePerformance(index) {
      const performance = app.performanceHistory[index];
      
      if (!performance) return;
      
      showConfirmationDialog(
        "Delete Performance",
        `Are you sure you want to delete the performance record for ${formatDate(performance.date)}?`,
        () => {
          // Remove performance
          app.performanceHistory.splice(index, 1);
          
          // Save to localStorage if auto-save is enabled
          if (app.settings.autoSave) {
            saveToLocalStorage();
          }
          
          // Update UI
          updatePerformanceHistory();
          
          showToast("Performance record deleted!");
        }
      );
    }
    
    // Run the initialization
    init();
  </script>
</body>
</html>